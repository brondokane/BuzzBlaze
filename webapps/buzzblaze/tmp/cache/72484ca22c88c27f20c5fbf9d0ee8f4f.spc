a:4:{s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"feed";a:1:{i:0;a:6:{s:4:"data";s:141:"
  
  
  
  
  
 
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:3:{s:27:"http://www.w3.org/2005/Atom";a:5:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:27:"RailsTips by John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:3:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:3:{s:4:"type";s:9:"text/html";s:4:"href";s:26:"http://railstips.org/blog/";s:3:"rel";s:9:"alternate";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:3:{s:3:"rel";s:4:"self";s:4:"type";s:20:"application/atom+xml";s:4:"href";s:37:"http://feeds.feedburner.com/railstips";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:2;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:2:{s:3:"rel";s:3:"hub";s:4:"href";s:32:"http://pubsubhubbub.appspot.com/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:26:"http://railstips.org/blog/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2011-02-21T22:16:07-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:5:"entry";a:15:{i:0;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:25:"Give Yourself Constraints";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/UM7Z2exncy8/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4d5b0d78dabe9d1d76000031";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2011-02-21T10:11:51-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2011-02-20T23:02:00-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:3:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:12:"applications";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:6:"gauges";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:2;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:8:"thoughts";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:120:"<p>In which I ramble for a bit about a recent project and how the constraints I put on myself helped make it happen.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:7699:"<p>Recently, I had a hernia and surgery to fix it. This knocked me out of the game and onto the couch for a couple weeks. During my recovery, I had a lot of time to think. I also had a lot of time <strong>to miss what I do every day</strong>.</p>
<p>This was the longest period in several years for me without creating. Once I felt good enough to get back at it, even if only for a few hours, I decided to focus all this pent up energy on something new.</p>
<p>What I wanted to do, was <strong>to think through a problem different than I ever have</strong>. I have been creating applications pretty much the same way for quite some time. Sure, MongoDB changed my methods a bit, but I knew I had not used it to its full potential, as I typically start all new Mongo projects with MongoMapper.</p>
<h2>What to Build</h2>
<p>First, I thought about what to build. I have a plethora of &#8220;someday&#8221; ideas that have never made it out of that stage. One of those ideas was to build a <strong>simple analytics program</strong>.</p>
<p>Sure, there are a crap ton of analytics apps out there, including Google Analytics, but not a one thus far has hit the sweet spot I am looking for.</p>
<h2>The Old Constraint</h2>
<p>Back in the day, I would entertain every whim I had. <strong>This is great for learning</strong> a lot of new things, but I never really focused and finished anything. What I had was a project directory full of half (or less) finished ideas.</p>
<p>When I actually forced myself to work on only a project or two (I chose MongoMapper and <a href="http://get.harmonyapp.com">Harmony</a>), I noticed that <strong>I actually finished things and had something to show for myself</strong>.</p>
<p><strong>Important</strong>: The constraint of what I could work on made me more productive than working on whatever I was inspired to work on.</p>
<p>That said, rules are made to be broken, right? Plus, this new project was not entirely misguided. <a href="http://get.harmonyapp.com">Harmony</a> manages websites. Websites need analytics. There is definitely a benefit to Harmony in building an analytics system that can be <strong>deeply integrated</strong>, so I began work.</p>
<h2>The New Constraints</h2>
<p>Since I was bending the rules a bit, I decided to give myself different constraints this time. Rather than what I would work on, I focused on what tools I could use to do the work. The thought was that <strong>forcing myself to avoid my comfort tools would lead to thinking outside of my usual box</strong>.</p>
<p>The first constraint I made was that I could only use the Mongo Ruby driver. No ActiveRecord, MongoMapper or any other object mapper.</p>
<p>Second, no aggregate querying for reports. All of the analytics had to be built on the fly as each hit came in. I told myself I could not even store the individual hit data that was generated each time a page was tracked.</p>
<p>Third, no signup or authentication. I wanted to focus on the core functionality (tracking views) instead of spending my time authenticating users and all that crap.</p>
<p>Fourth, I cannot remember, so lets move on.</p>
<h2>The Prototype</h2>
<p>Within a few hours, using Sinatra and the MongoDB Ruby driver, I had a little prototype working. Each hit was a single MongoDB operation, an <a href="http://www.mongodb.org/display/DOCS/Updating#Updating-UpsertswithModifiers">upsert</a> based on the host, with year, month, day, and hour information stored in nested hashes. The nested hashes were updated in the operation using <a href="http://www.mongodb.org/display/DOCS/Updating#Updating-%24inc">$inc</a>. It did not do much, but it was pretty cool.</p>
<p>I am aware, especially now, how simple that first prototype was, but it felt great to create again. Next, I threw the app up on <a href="http://heroku.com">Heroku</a> and <a href="http://mongohq.com">MongoHQ</a>, so I could try it out tracking this site you are reading.</p>
<p>Both are free to try, so it cost me nothing to get something up that I and others could react to. I showed it to the rest of the <a href="http://orderedlist.com">Ordered List</a> team and every one shared the excitement.</p>
<h2>The Result</h2>
<p>I am amazed at what we have come up with in such a short amount of time (4 weeks using occasional evenings/weekends). In fact, the constraint of time is why Gauges is where it is today. We were really productive in the hours we snatched to work on it, because they were few and far between.</p>
<p>Steve came up with a great name, found a matching domain (which is a <strong>miracle</strong> these days) and <a href="http://gaug.es">Gaug.es</a> was born.</p>
<h3>Home Page</h3>
<p><a href="http://gaug.es"><img src="/assets/4d61d9acdabe9d65b6000250/article_full/gauges_home.jpg" class="image full" alt="" /></a></p>
<h3>Dashboard</h3>
<p><a href="http://gaug.es"><img src="/assets/4d61dadbdabe9d5e73000647/article_full/gauges_dashboard.jpg" class="image full" alt="" /></a></p>
<p><strong>Note</strong>: Holy crap did Steve (<a href="http://twitter.com/orderedlist">@orderedlist</a> on Twitter) knock the design out of the park. Dude has skills!</p>
<h2>Conclusion</h2>
<p>The last 4 weeks working on Gauges has made me feel, at times, <strong>like a kid again</strong>. It is almost like we were racing to the next fence post (sue me, I grew up on a farm). <strong>Sure, I broke the original constraints I set, but without them, I would never have started</strong>.</p>
<p>To break constraint numero uno, I used <a href="http://railstips.org/blog/archives/2011/01/27/data-modeling-in-performant-systems/">ToyStore</a>, with my <a href="https://github.com/jnunemaker/adapter-mongo">mongo adapter</a>. Any service that involves user input needs validations and the like, and I was not in the mood to build them from scratch.</p>
<p>I actually stuck with constraint number two. All of the tracking code uses upserts with MongoDB modifiers to create and update reports on the fly.</p>
<p>Constraint number three also fell to the wayside. You cannot very well make money on a service that requires no signup (or at least it is increasingly difficult), so you do in fact have to sign up and in to use Gauges. That said, right now we are just testing things out, so we are controlling things with a code.</p>
<p>Whether it be the tools that you use, the projects that you work on, or the people you work with, <strong>give yourself constraints</strong>. Create something that you have always wanted. Get other people excited about it. Work cannot always be &#8220;work&#8221;.</p>
<p>P.S. If Gauges is something you are interested in and you would like to be an early tester, <a href="mailto:john@orderedlist.com">let me know</a>. The main goals right now are hosted (no setup/servers), easy sharing with other people, how much traffic, where was it from and where was it to.</p>
<p>Plus, we have a few great ideas for down the road, once we get the basics ironed out. Thus far, Gauges is really scratching an itch I have had for a while and I am stoked.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=UM7Z2exncy8:6AJwggyJ9H4:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=UM7Z2exncy8:6AJwggyJ9H4:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=UM7Z2exncy8:6AJwggyJ9H4:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/UM7Z2exncy8" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:72:"http://railstips.org/blog/archives/2011/02/20/give-yourself-constraints/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:1;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:35:"Data Modeling in Performant Systems";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/Otb2BDlt_7A/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4d40d9b8dabe9d733b00001b";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2011-02-21T22:16:07-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2011-01-27T11:15:00-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:3:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:7:"adapter";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:4:"gems";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:2;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:8:"toystore";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:100:"<p>In which I talk about how to make things fast and a new project that lets you model that way.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:14513:"<p>I have been working on Words With Friends, a high traffic app, for over six months. Talk about trial by fire. I never knew what scale was. Suffice to say that I have learned a lot.</p>
<p>Keeping an application performant is all about finding bottlenecks and fixing them. <strong>The problem is each bottleneck you fix leads to more usage and a new bottleneck</strong>. It is a constant game of cat and mouse. Sometimes you are the cat and sometimes, well, you are not.</p>
<p>Most of the time, the <strong>removal of those bottlenecks is about moving hot data to places that can serve it faster</strong>. Disks are slow, memory is fast, enter more memcached.</p>
<p>Over time, you work and work to move hot data into memory and simplify your data access to fit into memory. Key here, value there. Eventually, you get to a place where <strong>you have simplified how you access your data</strong> into simple key/value lookups.</p>
<p>Games get marshaled into a key named <code>"Game:#{id}"</code>. Joins are simplified to selecting ids and caching the array of ids into a key such as <code>"User:#{id}:active_game_ids"</code> or <code>"User:#{id}:over_game_ids"</code>. In turn, those arrays are turned into objects by un-marshaling the contents of <code>"Game:#{id}"</code>, etc.</p>
<p><strong>Your data model morphs from highly relational to key/value</strong> because key/value is fast and memcached can withstand a bruising.</p>
<p>Do it once, and you know how to do it in the future. The problem is by the time you get to this data model, it is kind of bolted on/in to your app.</p>
<p><strong>What if you could design it this way from the beginning?</strong> What if you had no option but to think through your data model in keys and values? Need your data in two different ways? Put it in two different places, etc, etc.</p>
<p>I have good news. <strong>Now you can</strong>.</p>
<h2>A Little History</h2>
<p>Not long into my tenure with <span class="caps">WWF</span>, we were hitting a lot of walls and there was a lot of talk about NoSQL. Mongo? Membase? Cassandra? Riak?</p>
<p>Which one will work best for the problem at hand? What if we could try them all really easily by just changing which place the data went to? What if we could try out more than one at once?</p>
<p>I sat down one weekend and started thinking about the app and realized what I just talked about above. Along the way, our data access changed from relational to key lookups. This made me think about a hash.</p>
<p>Hashes are so versatile, and yet, so constrained. <strong>Hashes are for reading, writing and deleting keys, just like key/value stores</strong>. I did a bit of GitHub searching and stumbled across <a href="https://github.com/wycats/moneta">moneta</a>, by Yehuda Katz.</p>
<p>Moneta immediately struck me as <strong>brilliant</strong>. I was shocked there was no activity around it. If you only allow yourself to read, write and delete with the same <span class="caps">API</span>, you can make nearly any data store talk the correct language.</p>
<p>I fiddled with it and forked it, but in the end, <strong>it was not quite what I was looking for</strong>. I liken it to my first house. I like the house, but having lived in it for six years, I know exactly what I want out of my next house.</p>
<p>The folks at Newtoy (now Zynga with Friends) had mentioned that they wanted to build their own object mapper and name it ToyStore&#8212;such a great name.</p>
<p><strong>In a fit of inspiration</strong> over the 4th of July weekend, I cranked out attributes and initialization, relying heavily on ActiveModel. It was really fun. I emailed the crew when the next work day came around and they were stoked.</p>
<p>It began to occupy some of my work-related time and <a href="http://twitter.com/#!/gdagley/">Geoffrey Dagley</a> started helping me with it. Over the next few weeks, Geof and I hammered out validations, serialization, callbacks, dirty tracking, and much more.</p>
<p><strong>Everything was built on the premise</strong> that the only acceptable methods that could be used to read, write and delete data were read, write and delete.</p>
<h2>Adapter: The Common Interface</h2>
<p>Over time <a href="http://opensoul.org">Brandon Keepers</a> got involved and ToyStore started looking pretty legit. We switched from using Moneta as the base to something I whipped together in a few hours, <a href="https://github.com/newtoy/adapter">Adapter</a>.</p>
<p>Defining an adapter is as simple as telling it how the client reads, writes and deletes data. You also have to define a clear method for convenience and to stick close the Ruby hash <span class="caps">API</span>.</p>
<p><strong>The client can be anything that you want to have a unified interface</strong>. For example, this is how you would create an adapter to store things in a ruby hash.</p>
<pre><code class="ruby">Adapter.define(:memory) do
  def read(key)
    decode(client[key_for(key)])
  end

  def write(key, value)
    client[key_for(key)] = encode(value)
  end

  def delete(key)
    client.delete(key_for(key))
  end

  def clear
    client.clear
  end
end</code></pre>
<p><code>key_for</code> ensures that most things can work as a key. <code>encode</code> and <code>decode</code> allow one to hook some kind of serialization in, whatever you fancy, be it Marshal, <span class="caps">JSON</span>, or whatever you can imagine.</p>
<p>By defining those methods, we can now get an instance of this adapter and connect it to a client. In the example above, the client is just a plain ruby hash, but in other adapters, it could be an instance of Redis (<a href="https://github.com/jnunemaker/adapter-redis">adapter</a>), Memcached (<a href="https://github.com/jnunemaker/adapter-memcached">adapter</a>), or maybe a Riak bucket (<a href="https://github.com/jnunemaker/adapter-riak">adapter</a>).</p>
<pre><code class="ruby">adapter = Adapter[:memory].new({}) # sets {} to client
adapter.write('foo', 'bar')
adapter.read('foo') # 'bar'
adapter.delete('foo')
adapter.fetch('foo', 'bar') # returns bar and sets foo to bar

# [] and []= are aliased to read and write
adapter['foo'] = 'bar'
adapter['foo'] # 'bar'</code></pre>
<p>Adapters can also be defined using a block (like above), a module, or both (module included first, then block so you can override module with block).</p>
<p>Adapters can also define atomic locking mechanisms, see the <a href="https://github.com/jnunemaker/adapter-memcached/blob/master/lib/adapter/memcached.rb">memcached</a> and <a href="https://github.com/jnunemaker/adapter-redis/blob/master/lib/adapter/redis.rb">redis</a> adapters for their locking implementations. The more opaque the object, the more you need to lock. Or, in the case of riak, the adapter can handle <a href="https://github.com/jnunemaker/adapter-riak/blob/master/lib/adapter/riak.rb">read conflicts</a>.</p>
<h2>ToyStore: The Mapper Fixings on top of Adaper</h2>
<p>Once you have secured how your data layer speaks the adapter interface you can use the real power, ToyStore.</p>
<p>Lets say you want to store your users in redis. Create your class, include the Toy::Store, and set it to store in redis.</p>
<pre><code class="ruby">require 'toystore'
require 'adapter/redis'

class User
  include Toy::Store
  store :redis, Redis.new

  attribute :email, String
end</code></pre>
<p>From there, you can go to town, defining attributes, validations, callbacks and more.</p>
<pre><code class="ruby">class User
  include Toy::Store
  store :redis, Redis.new

  attribute :email, String
  validates_presence_of :email
  before_save :lower_case_email

private
  def lower_case_email
    self.email = email.downcase if email
  end
end

user = User.new
pp user.valid?

user.email = 'John'
pp user.save

pp user
pp User.get(user.id)

user.destroy
pp User.get(user.id)</code></pre>
<p>Change your mind? Decide that you do not want to use Redis? Fancy Riak? Simply change the store to use the riak adapter and you are rolling.</p>
<pre><code class="ruby">require 'toystore'
require 'adapter/riak'

class User
  include Toy::Store
  store :riak, Riak::Client.new['users']

  attribute :email, String
end</code></pre>
<p>Boom. <strong>You just completely changed your data store in a couple lines of code</strong>. Practical? Yes and no. Cool? Heck yeah.</p>
<p>What all does Toy::Store come with out of the box? So glad you asked.</p>
<ul>
	<li><strong>Attributes</strong> &#8211; attribute :name, String (or some other type) Can be virtual which works just like attr_accessor but all the power of dirty tracking, serialization, etc. Also, can be abbreviated which means :first_name could be the method you use, but in the data store the attribute is :fn. Save those bytes! Allows for default values and defaults can be procs.</li>
	<li><strong>Typecasting</strong> &#8211; Same type system as MongoMapper. One day they will share the exact same type system in its own gem, for now duplicated.</li>
	<li><strong>Callbacks</strong> &#8211; all the usual suspects.</li>
	<li><strong>Dirty Tracking</strong> &#8211; save, create, update, destroy</li>
	<li><strong>Mass assignment security</strong> &#8211; attr_accessible and attr_protected</li>
	<li><strong>Proper cloning</strong></li>
	<li><strong>Lists</strong> &#8211; arrays of ids. If user has many games, user would have list :games which stores in game_ids key on user and works just like an association.</li>
	<li><strong>Embedded Lists</strong> &#8211; array of hashes. More consistent than MongoMapper, which will soon reap the benefits of the work on Toy Store embedded lists.</li>
	<li><strong>References</strong> &#8211; think belongs_to by a different (better?) name. Post model could reference :creator, User to add creator_id key and relate creator to post.</li>
	<li><strong>Identity Map</strong> &#8211; On by default. Should be thread-safe.</li>
	<li><strong>Read/write through caching</strong> &#8211; If you specify a cache adapter (say memcached), ToyStore will write to memcached first and read from memcached first, populating the cache if it was not present.</li>
	<li><strong>Indexing</strong> &#8211; Need to do lookups by email? index :email and whenever a user is saved the user data is written to one key and the email is written as another key with a value of the user id.</li>
	<li><strong>Logging</strong></li>
	<li><strong>Serialization</strong> (<span class="caps">XML</span> and <span class="caps">JSON</span>)</li>
	<li><strong>Validations</strong></li>
	<li><strong>Primary key factories</strong></li>
</ul>
<p>It pretty much has you covered. Adapters for <a href="https://github.com/jnunemaker/adapter-redis">redis</a>, <a href="https://github.com/jnunemaker/adapter-memcached">memcached</a>, <a href="https://github.com/jnunemaker/adapter-riak">riak</a>, and <a href="https://github.com/therealadam/adapter-cassandra">cassandra</a> already exist. Expect a Mongo one soon. Have to make a few tweaks to adapter. Yep, even Mongo.</p>
<p>What are other adapters that could be created? Membase? Just start with the memcached adapter and override <code>key_for</code>. Git? File system? <span class="caps">REST</span>? MySQL?! I love it!</p>
<h2>The Future</h2>
<p><strong>The future is not picking a database and forcing all your data into it</strong>. The future (heck, now even) is the right database for the job and your application may need several of them.</p>
<p>All this said, in no way do I think ToyStore is going to take the world by storm. <strong>It is a different way to build applications</strong>. This way comes with great power, but great confusion as well.</p>
<p>Currently, each model is serialized <strong>into one key in the store</strong>, based on how the adapter does encode/decode. Eventually, I would like to add the ability <strong>to store different attributes in different keys</strong>. For example, maybe you want active_game_ids to be stored in a key by itself so you don&#8217;t have to constantly save the entire user object.</p>
<p>I can also see a use for <strong>being able to store an attribute not just a different key, but a different store entirely</strong>. Store your user objects in Riak, but active_game_ids in a Redis set. This is where it would get <strong>really</strong> powerful.</p>
<p>At any rate, I am very excited about this project and I think it has a lot of potential. I would also like to add that <strong>MongoMapper is here to stay</strong>.</p>
<p>In fact, <strong>I learned from my mistakes on MongoMapper when building ToyStore</strong> and will be back-porting those learned experiences very soon. Expect a flurry of activity over the next little while.</p>
<h2>Closing Thanks</h2>
<p><strong>Huge thanks</strong> to <a href="http://newtoyinc.com/">Newtoy</a> (now <a href="http://newtoyinc.com/wp/blog/today-is-a-big-day-for-newtoy/">Zynga with Friends</a>) for allowing Geof and I to open source this. Several pieces of ToyStore were built on their dime and I really appreciate their contribution to the Ruby and Rails community!</p>
<p>As is typical with new projects, there are probably rough spots and good luck finding documentation. I have included a bevy of examples and the tests do a superb job at explaining the functionality of each method/feature.</p>
<p>Let me know what your thoughts are and be sure to kick the tires!</p>
<h2>Roundup of Links</h2>
<ul>
	<li><a href="https://github.com/newtoy/adapter">Adapter</a></li>
	<li><a href="https://github.com/newtoy/toystore">ToyStore</a></li>
	<li><a href="https://github.com/jnunemaker/adapter-redis">Redis Adapter</a></li>
	<li><a href="https://github.com/jnunemaker/adapter-memcached">Memcached Adapter</a></li>
	<li><a href="https://github.com/jnunemaker/adapter-riak">Riak Adapter</a></li>
	<li><a href="https://github.com/therealadam/adapter-cassandra">Cassandra Adapter</a></li>
</ul><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=Otb2BDlt_7A:sAaUwqACRPw:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=Otb2BDlt_7A:sAaUwqACRPw:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=Otb2BDlt_7A:sAaUwqACRPw:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/Otb2BDlt_7A" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:82:"http://railstips.org/blog/archives/2011/01/27/data-modeling-in-performant-systems/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:2;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:14:"Year In Review";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/peGrSOv-b5k/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4d1e189bdabe9d6407000005";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-12-31T13:56:57-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-12-31T13:05:00-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:3:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:4:"gems";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:7:"harmony";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:2;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:7:"mongodb";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:41:"<p>In which I recap a very good year.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:6354:"<p>One of the main reasons that I write is for reflection. Blogging gives me a history of what I was interested in and when. In 2008, I <a href="http://railstips.org/blog/archives/2008/12/22/the-2008-smrgsbord/">posted the Smörgåsbord</a>. I skipped 2009, for whatever reason, but 2010 will not suffer the same fate.</p>
<h2>Bang!</h2>
<p>The first post of the year was pretty huge for me. It was the first post using <a href="http://get.harmonyapp.com">Harmony</a>, the website management system that we are building at <a href="http://orderedlist.com">Ordered List</a>. We even released it for public consumption on <a href="http://railstips.org/blog/archives/2010/07/23/august-3rd/">August 3rd</a>.</p>
<p>Post number two was my most popular post of all time. It took off so fast that I could not even enjoy it. I immediately had to <a href="http://railstips.org/blog/archives/2010/01/22/multiple-domain-page-caching/">add page caching</a> to Harmony so it could handle the load.</p>
<p>I Have No Talent had 25k views in the first two days, but that did not prepare me for day three. Day three ended with over 60k views and by the time the dust settled on day four, <strong>it was over 100k views</strong>. Crazy!</p>
<p>Below is a screenshot of views for the entire year. Note how most of the year looks like a flat line next to the no talent post and the other hit of the year, <a href="http://railstips.org/blog/archives/2010/10/14/stop-googling/">Stop Googling</a>.</p>
<p><img src="/assets/4d1e1b2bdabe9d6562000001/article_full/rt_traffic.jpg" alt="" /></p>
<h2>Thoughts</h2>
<p>Every year I try to do a few posts that are just thoughts I have been having or that someone else had and I respect.</p>
<p>This year I posted on <a href="http://railstips.org/blog/archives/2010/01/24/just-in-time-not-just-in-case/">Just in Time, Not Just in Case</a>, <a href="http://railstips.org/blog/archives/2010/01/26/correct-beautiful-fast-in-that-order/">Correct, Beautiful, Fast, In That Order</a>, and <a href="http://railstips.org/blog/archives/2010/12/24/improving-your-methods/">Improving Your Methods</a>. Each of these posts are something I believe really strongly in.</p>
<h2>Presentations</h2>
<p>This was the year of speaking for me. There were a few stretches where I was prepping for a presentation every other week. That is definitely a bit hectic when each presentation is on a new and different topic.</p>
<p>A few of the highlights were <a href="http://railstips.org/blog/archives/2010/04/18/i-have-no-talent-redux/">keynoting the Great Lakes Ruby Bash</a> on my lack of talent, <a href="http://railstips.org/blog/archives/2010/05/10/mongosf-mongomapper-video/">talking about MongoMapper at MongoSF</a>, and <a href="http://railstips.org/blog/archives/2010/06/16/railsconf-2010/">teaching how to steal</a> at RailsConf 2010.</p>
<p>I even posted on how to <a href="http://railstips.org/blog/archives/2010/05/05/improve-your-presentations-in-under-50/">Improve Your Presentations in Under $50</a>. If you are presenting any time soon, definitely check that post out.</p>
<h2>Projects</h2>
<p>This was the year of the tiny project for me. I have worked on so many applications now that I am beginning to see a lot of patterns. Each time I repeated myself, I did my best to move the abstraction into its own gem and share it for all or none to use.</p>
<p>This year, I released <a href="http://railstips.org/blog/archives/2010/02/27/canable-the-flesh-eating-permission-system/">Canable</a> to help with permissions, <a href="http://railstips.org/blog/archives/2010/03/26/a-nunemaker-joint/">Joint</a> to make file uploads with GridFS easy, <a href="http://railstips.org/blog/archives/2010/03/30/because-gem-names-are-like-domains-in-the-90s/">Whois</a> to aid in naming your project, <a href="http://railstips.org/blog/archives/2010/07/15/caching-with-mongo/">Bin</a> for caching in Mongo, <a href="http://railstips.org/blog/archives/2010/06/16/mongomapper-08-goodies-galore/">Plucky</a> for sexy Mongo querying, <a href="http://railstips.org/blog/archives/2010/12/20/hunt-an-experiment-in-search/">Hunt</a> for easy search with Mongo, and <a href="http://railstips.org/blog/archives/2010/12/28/a-scam-i-say/">Scam</a> a simple enum/fake model helper.</p>
<p>In addition to the aforementioned new projects, I released several updates to MongoMapper, including <a href="http://railstips.org/blog/archives/2010/02/21/mongomapper-07-plugins/">plugins</a>, <a href="http://railstips.org/blog/archives/2010/02/21/mongomapper-07-identity-map/">identity map</a>, and <a href="http://railstips.org/blog/archives/2010/06/16/mongomapper-08-goodies-galore/">scopes</a>.</p>
<p>I also tried to share some of what I learned building MongoMapper in <a href="http://railstips.org/blog/archives/2010/07/19/creating-duplicable-objects/">Creating Duplicable Objects</a> and <a href="http://railstips.org/blog/archives/2010/08/29/building-an-object-mapper-override-able-accessors/">Over-ridable Accessors</a>, and <a href="http://railstips.org/blog/archives/2010/10/24/the-chain-gang/">The Chain Gang</a>.</p>
<h2>Numbers</h2>
<p>Though I posted about half as many times as in 2009, I feel the quality went way up. In total, <strong>RailsTips garnered over 700,000 views in 2010</strong>. Blows my mind that it has grown to that in three and half years.</p>
<p>Even more mid blowing is how much I have grown in that time. From barely knowing Rails, to creating one of the more popular object mappers. From working at Notre Dame, to owning my own business.</p>
<p>I feel that all of this really is <strong>a testament to what a lot hard work can result in</strong>. I cannot wait to see what 2011 brings.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=peGrSOv-b5k:vVcZL9pivF0:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=peGrSOv-b5k:vVcZL9pivF0:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=peGrSOv-b5k:vVcZL9pivF0:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/peGrSOv-b5k" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:61:"http://railstips.org/blog/archives/2010/12/31/year-in-review/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:3;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:13:"A Scam I Say!";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/ixXRo8n0G4M/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4d1a5108dabe9d24040001fc";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-12-28T16:22:42-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-12-28T16:18:00-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:4:"gems";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:75:"<p>In which I release a new gem for simple, fake, memory-backed models.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:5025:"<p>Today, I repeated myself in a particular way for the last time. In at least four places in Harmony, I had faux classes that responded to all, find, create, etc. and initialized attributes from a hash. As I went to write another, I realized I had a problem and it was time for a new open source project.</p>
<h2>A Little History</h2>
<p>Harmony has a Site model, which has a site mode. The site mode is either &#8216;development&#8217; or &#8216;live&#8217;. Back in the day, I would have created a SiteMode model that was backed by the database and hooked up all the relationships between Site and SiteMode.</p>
<p>Over the years, I have realized that is a waste. The information in that database table rarely changes and if it does, it is usually accompanied by other code changes and a deploy. <strong>This type of information is perfect for just storing in memory</strong>. If you need to change it, do so, commit, and deploy.</p>
<p>When I was originally working on site mode&#8217;s a few years back, I created a fake model that looked similar to this:</p>
<pre><code class="ruby">class SiteMode
  cattr_accessor :modes
  @@modes = [
    {:id =&gt; 1, :name =&gt; 'live'},
    {:id =&gt; 2, :name =&gt; 'development'},
  ]
  
  def self.[](id)
    SiteMode.new(id)
  end
  
  def self.all
    @@modes.map { |m| SiteMode.new(m[:id]) }
  end

  attr_accessor :id, :name
  
  def initialize(id)
    self.class.modes.detect { |m| m[:id] == id }.each_pair do |attr, value|
      self.send("#{attr}=", value)
    end
  end
  
  def password_required?
    id == 2
  end
  
  def display_name
    name.titleize
  end
end</code></pre>
<p>With just that code, Site could <code>belong_to :site_mode</code> and everything just worked. I got my same relationships and instead of querying a database (and having to keep that data in sync), everything was just stored in memory.</p>
<h2>The Scam</h2>
<p>Like I said, rather than create another fake model with all the same code and tests, I pulled out the shared pieces into a gem named <a href="http://github.com/jnunemaker/scam">scam</a>. With scam in the mix, the SiteMode model now looks like this:</p>
<pre><code class="ruby">class SiteMode
  include Scam

  attr_accessor :name

  def password_required?
    id == 2
  end

  def item_cache?
    id == 1
  end

  def display_name
    name.titleize
  end
end

SiteMode.create({
  :id   =&gt; 1,
  :name =&gt; 'live'
})

SiteMode.create({
  :id   =&gt; 2,
  :name =&gt; 'development'
})</code></pre>
<p>By just including Scam, we get all the enumerable functionality and such (see the <a href="https://github.com/jnunemaker/scam/blob/master/spec/scam_spec.rb">specs for more</a>). Now the SiteMode class deals specifically with site mode related code instead of how to initialize, create, and enumerate site modes. I switched the other classes that used the same idiom and was left with less code on the other side.</p>
<h2>A Few Notes</h2>
<p>This is nothing earth shattering, but it saves queries and wraps up an idiom I was using into a separate, well-tested piece of functionality that I can share not only across Harmony, but other applications as well.</p>
<p>One other thing worth noting is my choice of using id&#8217;s and having them be integers. <strong>The first advantage to using integers is size</strong>. The integer 2 is smaller to store than the string  &#8216;development&#8217;. That might not seem like a big deal, but after working on the projects I have recently, <strong>every byte still counts</strong>.</p>
<p><strong>The second reason is that integers are more flexible</strong>. Right now, 1 is live and 2 is development. If I decide I want another site mode to be the default instead of development, I can simply change development to a different id and create my new one as 2. The new one instantly becomes the new site mode for all sites with site_mode_id of 2.</p>
<p>If, on the other hand, I had used strings, I would have to map my new site mode to development and map development to something different. This would certainly lead to confusion in the code down the road. <strong>Strings have meaning because they are often words, whereas integers do not</strong>. Hope that makes sense.</p>
<p>At any rate, you can <code>gem install scam</code> if you have a need. If not, I hope some of the ideas in this post inspire you in some way.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=ixXRo8n0G4M:UplhlI9C0yk:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=ixXRo8n0G4M:UplhlI9C0yk:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=ixXRo8n0G4M:UplhlI9C0yk:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/ixXRo8n0G4M" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:59:"http://railstips.org/blog/archives/2010/12/28/a-scam-i-say/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:4;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:22:"Improving Your Methods";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/zG7E4POA_mQ/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4d14d31fdabe9d3b0e000006";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-12-24T12:31:04-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-12-24T12:06:00-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:8:"clogging";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:7:"testing";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:85:"<p>In which I share how I improved the process of running tests when I am coding.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:5223:"<p>I am always looking for ways to improve my efficiency while coding. One of the things that has been bothering me lately is how I run tests. Back in the day, I used autotest. Of late, I have been using <a href="https://github.com/mynyml/watchr">watchr</a>. Finally, this week I worked out something that does exactly what I want.</p>
<h2>Watchr</h2>
<p>Watchr is great at running arbitrary code when files change, but it cannot read my mind. When working on libraries, such as <a href="http://github.com/jnunemaker/hunt">Hunt</a>, <a href="http://github.com/jnunemaker/joint">Joint</a>, <a href="http://github.com/jnunemaker/mongomapper">MongoMapper</a>, etc., running tests/specs/features every time a file changes is fine. Heck, the whole suite MongoMapper runs in like 10 seconds.</p>
<p>You can take it a step further and make watchr even more responsive by making it run only related files. For example, whenever <code>lib/mongo_mapper/plugins/accessible.rb</code> is saved, most likely I want to run the <code>test/functional/test_accessible.rb</code> test (checkout MM&#8217;s <a href="https://github.com/jnunemaker/mongomapper/blob/master/specs.watchr">specs.watchr file</a> on Github).</p>
<h2>The Problem</h2>
<p>The issues I have had with watchr is more when working on big applications, such as <a href="http://get.harmonyapp.com/">Harmony</a> or Words with Friends. Bigger applications have bigger test suites and the process of automatically <strong>determining which tests I want to run when a file changes is difficult to impossible</strong> and changes from moment to moment.</p>
<p>After about a month of the pain that is manually running specific test files, I finally decided to think out what I wanted. The conclusion I came to was that I do not want tests to automatically run when I save a file. Instead, I want it to be <strong>easier to run specific tests based on keywords</strong>.</p>
<h2>The Solution</h2>
<p>Since I was working on Harmony at the time and it uses test/unit, I decided to write a script that would grep through the tests to match arguments I pass in and run all of the matches. Below is the script I came up with:</p>
<pre><code class="ruby">#!/usr/bin/env ruby
require File.dirname(__FILE__) + '/../config/boot'

if ARGV.empty?
  puts &lt;&lt;-EOH
Usage:
  script/test [test match string]

Example:
  script/test site
  script/test site_test
  script/test site_test account_test

  Above would run all tests matching site
  (ie: test/unit/site_test.rb, test/functional/admin/sites_controller.rb, etc.)

EOH
  exit
end

tests = Dir.glob(File.dirname(__FILE__) + '/../test/**/*').map do |file|
  # skip non test files
  next unless file.include?('_test')

  # check if any of the inputs match the file
  if ARGV.any? { |match| file =~ /#{match}/ }
    File.expand_path(file).gsub(Rails.root.join('test'), 'test')
  end
end.compact.join(' ')

test_loader = File.expand_path('../test_loader', __FILE__)

$stdout.sync = true
command = "bundle exec ruby -Itest #{test_loader} #{tests}"

puts(command)

IO.popen(command) { |com| com.each_char { |c| print(c) } }</code></pre>
<p>Note that it uses this test_loader, stolen directly from rake.</p>
<pre><code class="ruby">#!/usr/bin/env ruby

ARGV.each { |f| load f unless f =~ /^-/  }</code></pre>
<p>I dropped both of these files in the <code>script/</code> directory of Harmony. The cool thing is with not very much code, I can now do the following:</p>
<pre><code># run all of harmony's tests for liquid filters
# filters are all in a folder test/unit/filters
script/test filters

# same thing but drops
script/test drops

# run all the item related tests (from controllers, models, filters and drops
script/test item

# run unit tests for feed and feed template
script/test unit/feed

# run unit test for feed and feed drop test
script/test unit/feed feed_drop</code></pre>
<h2>Conclusion</h2>
<p>In general I am working on a very specific thing. All I want is to be able to test that very specific thing, on the fly, and very easily. script/test allows me to do that. Oh, and of course I aliased script/test to st, as I hate typing more than 2 characters. ;)</p>
<p>Not sure that this is valuable to anyone else as it is so specific to how I work, but it is the thought that counts. Also, It could easily be adapted to rspec or cucumber. I can say that it has drastically helped me.</p>
<p>I think the lesson to grep from this post is <strong>always be conscious of how you work and when you see a chance for improvement, spend a few minutes to make it happen</strong>.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=zG7E4POA_mQ:PHpTa0tGHmg:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=zG7E4POA_mQ:PHpTa0tGHmg:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=zG7E4POA_mQ:PHpTa0tGHmg:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/zG7E4POA_mQ" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:69:"http://railstips.org/blog/archives/2010/12/24/improving-your-methods/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:5;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:29:"Hunt, An Experiment in Search";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/aTcLPy-JOj0/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4d0f9128dabe9d64dd00016e";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-12-20T19:02:05-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-12-20T19:01:00-05:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:4:"gems";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:11:"mongomapper";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:56:"<p>In which I share some new code I am playing with.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:5726:"<p>I already <a href="http://twitter.com/#!/jnunemaker/status/16724019642372096">mentioned this on Twitter</a>, but for those of you that do not follow me there I thought I would take some time out of my day for a quick write up.</p>
<p>Quite often for little pet projects, I want search. While I am whole-heartedly behind <a href="http://outoftime.github.com/sunspot/">Sunspot</a> and <a href="http://lucene.apache.org/solr/">Solr</a> for anything serious, most of the time I will gladly sacrifice accuracy for simplicity.</p>
<p>This weekend I spent a couple hours whipping together <a href="http://github.com/jnunemaker/hunt">Hunt</a>, a really basic MongoMapper plugin that makes it easy to add basic search to your application.</p>
<h2>Install/Usage</h2>
<p>Install is obvious, but I will put it here so you can copy and paste.</p>
<pre><code>gem install hunt</code></pre>
<p>Once installed, you just have to declare the plugin in your model, and then tell it what you want to search on.</p>
<pre><code class="ruby">class Note
  include MongoMapper::Document

  key :title, String

  # Declare plugin and what to search
  plugin Hunt
  searches :title
end</code></pre>
<p>With just those two lines, Hunt will start tracking terms and allow you to search through them. The handy thing is that the search method just returns a scope, allowing you to further filter it or do counting and pagination.</p>
<pre><code class="ruby">Note.create(:title =&gt; 'A different test')
Note.search('test').count    # 1
Note.search('testing').count # 1

Note.search('testing').all
# [#&lt;Note searches: {"default"=&gt;["differ", "test"]}, title: "A different test", _id: BSON::ObjectId('...')&gt;]

Note.search('test').paginate(:page =&gt; 1)
# [#&lt;Note searches: {"default"=&gt;["differ", "test"]}, title: "A different test", _id: BSON::ObjectId('...')&gt;]
</code></pre>
<h2>Behind the Scenes</h2>
<p>So how does Hunt work? Before save, it gets the value of each key we want to search on, mashes them together into a big string and then does the following:</p>
<ul>
	<li>squeezes multiple spaces together</li>
	<li>splits string on space into array</li>
	<li>downcases all words</li>
	<li>rejects all words less than 2 in size</li>
	<li>rejects all words in an ignore list (do, don&#8217;t, you, yours, etc.)</li>
	<li>strips punctation from each word</li>
	<li>rejects any blank words</li>
	<li>stems each word</li>
	<li>uniqs the remaining stems</li>
</ul>
<h3>Stemming</h3>
<p>Probably most of that seems logical, but stemming may be unfamiliar to you. I was unfamiliar too before doing a bit of research. <a href="http://en.wikipedia.org/wiki/Stemming">Stemming</a> is the process of reducing inflected words to their root (ie: testing, tested, and tests to test).</p>
<p>I think of stemming as word normalization. As long as you normalize all the words you want to search on and normalize the search terms each time you query, your searches can be more intelligent than just exact matches.</p>
<p>I found several gems for stemming and after some cursory examination and benchmarking went with <a href="http://rubygems.org/gems/fast-stemmer">fast-stemmer</a>.</p>
<h3>Indexing</h3>
<p>Hunt automatically creates a key named searches. It then stores the array of stemmed words in a key named default inside searches.</p>
<pre><code class="ruby">Note.create(:title =&gt; 'This is a test')
#&lt;Note searches: {"default"=&gt;["test"]}, title: "This is a test", _id: BSON::ObjectId('...')&gt;

Note.create(:title =&gt; 'A different test')
#&lt;Note searches: {"default"=&gt;["differ", "test"]}, title: "A different test", _id: BSON::ObjectId('...')&gt;</code></pre>
<p>I chose a hash instead of an array because it is more flexible going forward (think named searches of different key combinations) and affects nothing in the short term.</p>
<p>Knowing this, we can create a Mongo index on this key to ensure that queries stay snappy:</p>
<pre><code class="ruby">Note.ensure_index :'searches.default'</code></pre>
<p>If you always search scoped to a user and you have a user_id key, you could do a compound index:</p>
<pre><code class="ruby">Note.ensure_index [[:user_id, Mongo::Ascending], [:'searches.default', Mongo::Ascending]]</code></pre>
<p>Hunt makes no assumptions on how you actually want to index the key. It merely stores the stuff you want to index.</p>
<p>Also, like I said before, you can index as many or as few keys as you want. I put an <a href="https://github.com/jnunemaker/hunt/blob/master/examples/multiple.rb">example of multiple fields</a> on Github for you to peruse.</p>
<h2>Conclusion</h2>
<p>So what is the value of all this? It gave me a chance to play with stemming and solves my short term issue of wanting basic search without any extra infrastructure.</p>
<p>Would I recommend that you use it? Probably not. :) That said, feel free to hack around on it and see if you can add other interesting features, such as scoring.</p>
<p>If nothing else, I think it shows <strong>how flexible</strong> <a href="http://mongodb.org">MongoDB</a> can be.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=aTcLPy-JOj0:CtDSuPXVJbo:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=aTcLPy-JOj0:CtDSuPXVJbo:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=aTcLPy-JOj0:CtDSuPXVJbo:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/aTcLPy-JOj0" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:75:"http://railstips.org/blog/archives/2010/12/20/hunt-an-experiment-in-search/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:6;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:14:"The Chain Gang";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/NMKB85YznZI/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4cc49868dabe9d7ca5000080";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-10-24T21:42:28-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-10-24T16:34:00-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:4:"ruby";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:97:"<p>In which I share how to create an interface that is chain-able like ARel, Plucky and more.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:8072:"<p>Chain-able interfaces are all the rage &#8212; jQuery, ARel, etc. The thing a lot of people do not realize is how easy they are to create. Lets say we want to make the following work:</p>
<div class="multiline_code"><div class="CodeRay">
  <div class="code"><pre><span class="co">User</span>.where(<span class="sy">:first_name</span> =&gt; <span class="s"><span class="dl">'</span><span class="k">John</span><span class="dl">'</span></span>)
<span class="co">User</span>.sort(<span class="sy">:age</span>)
<span class="co">User</span>.where(<span class="sy">:first_name</span> =&gt; <span class="s"><span class="dl">'</span><span class="k">John</span><span class="dl">'</span></span>).sort(<span class="sy">:age</span>)
<span class="co">User</span>.sort(<span class="sy">:age</span>).where(<span class="sy">:first_name</span> =&gt; <span class="s"><span class="dl">'</span><span class="k">John</span><span class="dl">'</span></span>)</pre></div>
</div>
</div><p>First, we need to have a class method for both where and sort because we want to allow either one of them to be called and chained on each other.</p>
<div class="multiline_code"><div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">User</span>
  <span class="r">def</span> <span class="pc">self</span>.<span class="fu">where</span>(hash)
  <span class="r">end</span>

  <span class="r">def</span> <span class="pc">self</span>.<span class="fu">sort</span>(field)
  <span class="r">end</span>
<span class="r">end</span>

<span class="co">User</span>.where(<span class="sy">:first_name</span> =&gt; <span class="s"><span class="dl">'</span><span class="k">John</span><span class="dl">'</span></span>)
<span class="co">User</span>.sort(<span class="sy">:age</span>)</pre></div>
</div>
</div><p>Now we can call where or sort and we do not get errors, but we still cannot chain. In order to make this magic happen, lets make a query class. The query needs to know what model, what where conditions and what field to sort by.</p>
<div class="multiline_code"><div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">Query</span>
  <span class="r">def</span> <span class="fu">initialize</span>(model)
    <span class="iv">@model</span> = model
  <span class="r">end</span>

  <span class="r">def</span> <span class="fu">where</span>(hash)
    <span class="iv">@where</span> = hash
  <span class="r">end</span>

  <span class="r">def</span> <span class="fu">sort</span>(field)
    <span class="iv">@sort</span> = field
  <span class="r">end</span>
<span class="r">end</span></pre></div>
</div>
</div><p>Now that we have this, lets create new query objects when the User class methods are called and pass the arguments through.</p>
<div class="multiline_code"><div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">User</span>
  <span class="r">def</span> <span class="pc">self</span>.<span class="fu">where</span>(hash)
    <span class="co">Query</span>.new(<span class="pc">self</span>).where(hash)
  <span class="r">end</span>

  <span class="r">def</span> <span class="pc">self</span>.<span class="fu">sort</span>(field)
    <span class="co">Query</span>.new(<span class="pc">self</span>).sort(field)
  <span class="r">end</span>
<span class="r">end</span></pre></div>
</div>
</div><p>We might think we are done at this point, but the sauce that makes this all work is still missing. If you try our initial example, you end up with a cryptic error message.</p>
<pre>ArgumentError: wrong number of arguments (1 for 0)</pre>
<p>The reason is that in order for this to be chainable, we have to return self in Query#where and Query#sort.</p>
<div class="multiline_code"><div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">Query</span>
  <span class="r">def</span> <span class="fu">initialize</span>(model)
    <span class="iv">@model</span> = model
  <span class="r">end</span>

  <span class="r">def</span> <span class="fu">where</span>(hash)
    <span class="iv">@where</span> = hash
    <span class="pc">self</span>
  <span class="r">end</span>

  <span class="r">def</span> <span class="fu">sort</span>(field)
    <span class="iv">@sort</span> = field
    <span class="pc">self</span>
  <span class="r">end</span>
<span class="r">end</span></pre></div>
</div>
</div><p>Now, if we put it all together, you can see that this is the basics of creating a chain-able interface. Simply, do what you need to do and return self.</p>
<div class="multiline_code"><div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">Query</span>
  <span class="r">def</span> <span class="fu">initialize</span>(model)
    <span class="iv">@model</span> = model
  <span class="r">end</span>

  <span class="r">def</span> <span class="fu">where</span>(hash)
    <span class="iv">@where</span> = hash
    <span class="pc">self</span>
  <span class="r">end</span>

  <span class="r">def</span> <span class="fu">sort</span>(field)
    <span class="iv">@sort</span> = field
    <span class="pc">self</span>
  <span class="r">end</span>
<span class="r">end</span>

<span class="r">class</span> <span class="cl">User</span>
  <span class="r">def</span> <span class="pc">self</span>.<span class="fu">where</span>(hash)
    <span class="co">Query</span>.new(<span class="pc">self</span>).where(hash)
  <span class="r">end</span>

  <span class="r">def</span> <span class="pc">self</span>.<span class="fu">sort</span>(field)
    <span class="co">Query</span>.new(<span class="pc">self</span>).sort(field)
  <span class="r">end</span>
<span class="r">end</span>

puts <span class="co">User</span>.where(<span class="sy">:first_name</span> =&gt; <span class="s"><span class="dl">'</span><span class="k">John</span><span class="dl">'</span></span>).inspect
puts <span class="co">User</span>.sort(<span class="sy">:age</span>).inspect
puts <span class="co">User</span>.where(<span class="sy">:first_name</span> =&gt; <span class="s"><span class="dl">'</span><span class="k">John</span><span class="dl">'</span></span>).sort(<span class="sy">:age</span>).inspect
puts <span class="co">User</span>.sort(<span class="sy">:age</span>).where(<span class="sy">:first_name</span> =&gt; <span class="s"><span class="dl">'</span><span class="k">John</span><span class="dl">'</span></span>).inspect

<span class="c"># #&lt;Query:0x101020268 @model=User, @where={:first_name=&gt;&quot;John&quot;}&gt;</span>
<span class="c"># #&lt;Query:0x101020060 @model=User, @sort=:age&gt;</span>
<span class="c"># #&lt;Query:0x10101fe30 @model=User, @where={:first_name=&gt;&quot;John&quot;}, @sort=:age&gt;</span>
<span class="c"># #&lt;Query:0x10101fbb0 @model=User, @where={:first_name=&gt;&quot;John&quot;}, @sort=:age&gt;</span></pre></div>
</div>
</div><h2>Conclusion</h2>
<p>From here, all we need to do is define kickers, such as all, first, last, etc. that actually assemble and perform the query and return results. Hope this adds a little something to your repertoire next time you are building an interface. It does not work in every situation, but when applied correctly it can improve the usability of a library.</p>
<p>If you are interested in more on this, feel free to peak at the innards of <a href="http://github.com/jnunemaker/plucky">Plucky</a>, which provides a chain-able interface for querying MongoDB.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=NMKB85YznZI:jKLyYK-dBPk:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=NMKB85YznZI:jKLyYK-dBPk:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=NMKB85YznZI:jKLyYK-dBPk:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/NMKB85YznZI" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:61:"http://railstips.org/blog/archives/2010/10/24/the-chain-gang/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:7;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:13:"Stop Googling";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/DG8VRj6URgU/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4cb6f86adabe9d035c00011f";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-10-14T08:48:46-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-10-14T08:48:00-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:5:"rants";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:84:"<p>In which I expound on why you should go for the code first and google second.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:5313:"<p>Yesterday, one of my inter-web buddies IM&#8217;d me and asked if I had used <a href="http://github.com/pauldix/typhoeus">Typhoeus</a> before. I said yes, so he asked me if it was possible to follow redirects using it. He said he google&#8217;d it and nothing turned up.</p>
<p>I sharply responded, &#8220;<strong><span class="caps">LOOK</span> AT <span class="caps">THE</span> <span class="caps">CODE</span>!</strong>&#8221;. We had some banter back and forth and a few minutes later he was automatically following redirects. <strong>It seems these days that developers often think if something does not turn up in a google search, it does not exist</strong>.</p>
<h2>The John Nunemaker Approach</h2>
<p>So how would I have approached my dudes problem?</p>
<ol>
	<li>Open a browser and type in github.com.</li>
	<li>Search for typhoeus.</li>
	<li>Click on Paul Dix&#8217;s repo.</li>
	<li>Click on lib/. lib is always where the guts of any Ruby gem are so it is a sensible first start.</li>
	<li>Click on typheous/. Not the ruby file, but the directory. Most good gems just have miscellaneous top level things in the ruby file of the gem name. All the guts sit in the folder named after the gem.</li>
	<li>Scanned for and clicked on the file named request.rb, which seemed like a good place to start, since we are looking to make a request.</li>
	<li>Starting at line 5 there is an attr_accessor full of options, two of which stuck out to me &#8212; follow_location and max_redirects. Both of these seemed related to what he was trying to do. I also noticed right below that Paul has some inline documentation which mentions all the options, including the aforementioned ones.</li>
	<li>Copied the link to the file, IM&#8217;d it to my dude and yelled again, &#8220;<span class="caps">LOOK</span> AT <span class="caps">THE</span> <span class="caps">CODE</span>!&#8221;</li>
</ol>
<p>If you do not know me, you may think I was a bit harsh breaking out the all caps, but it was all in good fun. The point, however, is not in good fun. <strong>It is deathly serious</strong>. As developers, we write code. If you can write code, you should also be able to read code.</p>
<h2>The Side Effects</h2>
<p>Beyond the fact that you will most likely find exactly the answer you are looking for, there are some other side effects.</p>
<p>First, as you look through the code, attempting to find your answer, <strong>you will quickly get a feeling for how the project is organized</strong> (or not organized). This helps determine if you really still want to use this project. If it looks like a mess, do not trust it. Find something else, or <strong><span class="caps">GASP</span></strong>, create your own project that does what you need. <a href="http://www.slideshare.net/jnunemaker/dont-repeat-yourself-repeat-others">Repeating others</a> is good.</p>
<p>Second, over time <strong>you will soak in more and more different coding styles and techniques</strong>. This will help you in your continuing efforts to get better as you are no longer in a box only looking at your own code. Several other people have expounded on the <a href="http://www.skorks.com/2010/05/why-i-love-reading-other-peoples-code-and-you-should-too/">benefits of code reading</a> so I will not dive in deep on that topic here, but suffice to say, it is really valuable.</p>
<p>Third, <strong>you will learn more about how the project works and may discover there is a better way</strong> to do what you are attempting. Some hidden option that no one has blogged about or utility class with handy helper methods.</p>
<p>Fourth, <strong>you will get faster and faster at tracking down where code is that you need</strong>. You will learn quickly how to find project&#8217;s code and where to find the code you need in the project. The steps above that describe my approach typically take me about the same amount of time as it would to search on google.</p>
<p>Fifth, and finally, and maybe most importantly, <strong>you will become addicted to reading code</strong>. You will start to shiver and shake when you have not had your fix in a few days. You mind will begin to race with ideas. You will see how someone else solved a problem and think of better ways.</p>
<p><strong>You will create</strong>. <strong>You will improve</strong>.</p>
<h2>Conclusion</h2>
<p>Ensure that GitHub is always near your fingertips. Install <a href="https://rubygems.org/gems/gemedit">gemedit</a> or a similar utility. Next time you go to google for an answer, stop, break open the code and learn. <strong>Here is hoping this article lights some peeps on fire instead of lighting a fire for them</strong>.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=DG8VRj6URgU:LVviWUyGJcQ:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=DG8VRj6URgU:LVviWUyGJcQ:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=DG8VRj6URgU:LVviWUyGJcQ:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/DG8VRj6URgU" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:60:"http://railstips.org/blog/archives/2010/10/14/stop-googling/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:8;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:50:"Building an Object Mapper: Override-able Accessors";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/hya0Z5m5cEM/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4c7ad275dabe9d37be000008";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-08-29T19:05:53-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-08-29T19:04:00-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:11:"mongomapper";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:4:"ruby";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:114:"<p>In which I explain how to make your attribute accessors override-able from scratch or by using ActiveModel.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:9445:"<p>There are several things I have learned building object mappers that I now take for granted. Last week while pairing with <a href="http://jasonseifer.com/">Jason</a>, I was explaining a trick and he said I should blog about it, so here goes nothing.</p>
<p>Let&#8217;s say you are building a new object mapper named TacoMapper. A sensible place to start is with attribute accessors. One other thing to note is that we don&#8217;t care about old news, so we won&#8217;t support Rails 2 in any fashion. Deciding this, we can take advantage of ActiveModel and new features in ActiveSupport.</p>
<h2>First Goal</h2>
<p>First, let&#8217;s think about <span class="caps">API</span>. Our first goal will be to make the following work:</p>
<pre><code class="ruby">class User
  include TacoMapper
  attribute :email
end

user = User.new
user.email = 'John@Doe.com'
puts user.email # "John@Doe.com"</code></pre>
<h2>First Solution</h2>
<p>The first thing we need is a class method named attribute.</p>
<pre><code class="ruby">require 'active_model'
require 'active_support/all'

module TacoMapper
  extend ActiveSupport::Concern

  module ClassMethods
    def attribute(name)
      attr_accessor(name)
    end
  end
end

class User
  include TacoMapper
  attribute :email
end

user = User.new
user.email = 'John@Doe.com'
puts user.email # "John@Doe.com"</code></pre>
<p>ActiveSupport::Concern is a handy little ditty that does a lot out of the box. In our case, it will automatically call extend(ClassMethods) and add our attribute class method whenever our TacoMapper module gets included. With just a tiny bit of code, we have met our first goal.</p>
<h2>Second Goal</h2>
<p>Now, I am going to throw a kink in the mix. The goal of this post is to create override-able accessors. Let&#8217;s say we want to <strong>override the email writer</strong> method and make sure that <strong>we always get lowercase</strong> emails. If we override our attribute accessors right now, we have to set the instance variable for things to work and we get no benefit from TacoMapper.</p>
<pre><code class="ruby">require 'active_model'
require 'active_support/all'

module TacoMapper
  extend ActiveSupport::Concern

  module ClassMethods
    def attribute(name)
      attr_accessor(name)
    end
  end
end

class User
  include TacoMapper
  attribute :email

  def email=(value)
    @email = value.to_s.downcase
  end
end

user = User.new
user.email = 'John@Doe.com'
puts user.email # "john@doe.com"</code></pre>
<p>In this simple example, that might be ok. But what if other things were in the mix, like dirty tracking, typecasting, etc.? Those other things would immediately stop working. <strong>Would it not be nice</strong> if we could just override our accessor and call super to get all the normal functionality of TacoMapper? I am glad you agree.</p>
<h2>Second Solution</h2>
<p>If you haven&#8217;t yet, you might want to read <a href="http://railstips.org/blog/archives/2009/08/20/lookin-on-up-to-the-east-side/">Lookin&#8217; on Up&#8230;To the East Side</a>, a post I wrote on how Ruby&#8217;s method lookups work. In it, I explain that if you include a module, you can override methods that were in the module and call super. We&#8217;ll do the same in TacoMapper so we can make things a bit more robust.</p>
<pre><code class="ruby">require 'active_model'
require 'active_support/all'

module TacoMapper
  extend ActiveSupport::Concern

  module ClassMethods
    def attribute_accessors_module
      @attribute_accessors_module ||= Module.new.tap { |mod| include(mod) }
    end

    def attribute(name)
      attribute_accessors_module.module_eval &lt;&lt;-CODE
        def #{name}
          @#{name}
        end

        def #{name}=(value)
          @#{name} = value
        end
      CODE
    end
  end
end

class User
  include TacoMapper
  attribute :email

  def email=(value)
    super(value.to_s.downcase)
  end
end

user = User.new
user.email = 'John@Doe.com'
puts user.email # "john@doe.com"</code></pre>
<p>Note that we get the same result as the previous example, except that now we can just call super and still take advantage of all the loveliness that TacoMapper will eventually provide. We changed a couple of key things, so lets cover the differences in detail.</p>
<p>First, we created a method (<code>attribute_accessors_module</code>) that returns a memoized module and includes it in the current class. No matter how many calls you make to this method, it will return the first module we created and it will only be included once, since we memoized it (<code>||=</code>).</p>
<p>Second, since we have a module and it is included in our class, all we have to do is module_eval our accessor methods into it. This is what is happening in the attribute method.</p>
<p>Third, instead of setting the email instance variable in the email= method, we just call super, which will call the method we module_eval&#8217;d into our accessors module.</p>
<p>Pretty sweet, eh?</p>
<h2>Third Solution</h2>
<p>We could stop there, but we said we were going to use ActiveModel a bit, right? ActiveModel has a module for attribute accessors that does the same thing as above and a bit more  (although a bit confusing).</p>
<pre><code class="ruby">require 'set'
require 'active_model'
require 'active_support/all'

module TacoMapper
  extend ActiveSupport::Concern
  include ActiveModel::AttributeMethods

  included do
    attribute_method_suffix('', '=')
  end

  module ClassMethods
    def attributes
      @attributes ||= Set.new
    end

    def attribute(name)
      attributes &lt;&lt; name.to_s
    end
  end

  module InstanceMethods
    def attribute(key)
      instance_variable_get("@#{key}")
    end

    def attribute=(key, value)
      instance_variable_set("@#{key}", value)
    end

    def attributes
      self.class.attributes
    end
  end
end

class User
  include TacoMapper
  attribute :email

  def email=(value)
    super(value.to_s.downcase)
  end
end

user = User.new
user.email = 'John@Doe.com'
puts user.email # "john@doe.com"</code></pre>
<p>Note that again, we get the same result and that we are using super as before. So what changed this time?</p>
<p>First, we included <code>ActiveModel::AttributeMethods</code>. We then took advantage of the <code>attribute_method_suffix</code> method it provides to declare that we would have a reader (<code>''</code>) and a writer (<code>'='</code>). Now all our attribute class method has to do is add the attribute to the set of attributes.</p>
<p>Lastly, we define methods that implement the suffix methods we defined (<code>attribute</code> and <code>attribute=</code>). Note that we also define the attributes instance method so that ActiveModel knows when it is dealing with one of our attributes. Now, it takes only a few more lines of code to add a boolean presence method.</p>
<pre><code class="ruby">require 'set'
require 'active_model'
require 'active_support/all'

module TacoMapper
  extend ActiveSupport::Concern
  include ActiveModel::AttributeMethods

  included do
    attribute_method_suffix('', '=', '?')
  end

  module ClassMethods
    def attributes
      @attributes ||= Set.new
    end

    def attribute(name)
      attributes &lt;&lt; name.to_s
    end
  end

  module InstanceMethods
    def attribute(key)
      instance_variable_get("@#{key}")
    end

    def attribute=(key, value)
      instance_variable_set("@#{key}", value)
    end

    def attribute?(key)
      instance_variable_get("@#{key}").present?
    end

    def attributes
      self.class.attributes
    end
  end
end

class User
  include TacoMapper
  attribute :email

  def email=(value)
    super(value.to_s.downcase)
  end
end

user = User.new
puts user.email? # false
user.email = 'John@Doe.com'
puts user.email? # true</code></pre>
<p>Using ActiveModel like this makes adding things like dirty tracking take a few minutes instead of a few hours. That said, the main point of this post is how the internals of ActiveModel actually work and how <strong>you can do it on your own</strong> if you so choose.</p>
<p>For those of you that are <strong>MongoMapper users</strong>, it has the same functionality built in though in a not as elegant way (which I will be updating soon). Also, your accessors are not used when loading things from the database, as that is handled internally. This means you can make your public accessors do whatever you want and it will not foobar the loading of your documents.</p>
<p>Hope this helps others trying to grok ActiveModel or build your own object mapper. If <strong>you enjoyed this post</strong> and <strong>would like to learn more</strong> about building an object mapper, <strong>let me know</strong> with a comment and I will try to round up a few more posts on the topic.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=hya0Z5m5cEM:3CyV0KZcQq8:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=hya0Z5m5cEM:3CyV0KZcQq8:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=hya0Z5m5cEM:3CyV0KZcQq8:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/hya0Z5m5cEM" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:96:"http://railstips.org/blog/archives/2010/08/29/building-an-object-mapper-override-able-accessors/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:9;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:10:"August 3rd";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/I-ZiIS-uz8g/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4c49a98bdabe9d3f6a000032";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-09-20T17:30:27-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-07-23T10:39:00-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:7:"harmony";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:59:"<p>In which I announce the date we will launch Harmony.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:1355:"<p>We are going to be <a href="http://get.harmonyapp.com/blog/opening-on-august-3rd/">opening Harmony&#8217;s doors</a> on August 3rd. It has been a long time coming and I am excited/nervous about the launch, but that is no reason to keep things locked up.</p>
<p>We already have over 60 live sites and several paying customers, so we are quite confident that Harmony is ready for consumption.</p>
<p>For now, you can <a href="http://get.harmonyapp.com/features/">check out the features</a>, <a href="http://get.harmonyapp.com/pricing/">view the pricing</a>, <a href="http://docs.harmonyapp.com/">read the documentation</a>, and <a href="http://get.harmonyapp.com/blog/">comment on the blog</a>.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=I-ZiIS-uz8g:Q7soEUJVQOU:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=I-ZiIS-uz8g:Q7soEUJVQOU:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=I-ZiIS-uz8g:Q7soEUJVQOU:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/I-ZiIS-uz8g" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:57:"http://railstips.org/blog/archives/2010/07/23/august-3rd/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:10;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:27:"Creating Duplicable Objects";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/FpAchjeUAVs/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4c4383e8dabe9d4dc6000005";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-07-19T08:35:16-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-07-19T08:00:00-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:4:"ruby";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:69:"<p>In which I divulge the existence and usage of initialize_copy.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:3923:"<p>While working on MongoMapper, I have run into several interesting problems and solutions. One of those problems came while creating Plucky, a library that adds chain-able queries on top of a Mongo::Collection ruby driver object.</p>
<p>Plucky is centered around the query class, which is made up of a criteria and options. Every time you call a chain-able method, you get a new query instance. The purpose of this is to make sure you never do anything destructive to an existing query. Let&#8217;s say you create a new plucky query instance and add a limit:</p>
<pre><code class="ruby">query = Plucky::Query.new(collection)
updated = query.limit(10)
updated.equal?(query) # false</code></pre>
<p>Calling limit clones the existing query and updates the limit of the new one like so:</p>
<pre><code class="ruby">class Query
  def limit(count=nil)
    clone.tap { |query| query.options[:limit] = count }
  end
end</code></pre>
<p>This makes it so we can chain and chain away never modifying the original query. Yay! Whoa, there, don&#8217;t get so happy. Each query has options and criteria. When you clone the query, it does in fact clone stuff, but unfortunately our  CriteriaHash and OptionsHash instances do not clone properly. They are both made up of source hashes and delegate most operations to those sources. Let&#8217;s take a look at the options hash:</p>
<pre><code class="ruby">class OptionsHash
  attr_reader :source

  def initialize(source)
    @source = source
  end

  def [](key)
    @source[key]
  end

  def []=(key, value)
    @source[key] = value
  end
end</code></pre>
<p>The goal of the class above is to behave mostly like a hash, but normalize options to &#8220;mongo speak&#8221;. For the purposes of this post, I will leave out the normalization and focus just on make the class do what I needed. Note that setting of source and send the [] and []= methods to source. Now that we have that code, let&#8217;s do some work with it:</p>
<pre><code class="ruby">hash1 = OptionsHash.new({:foo =&gt; 'bar'})
hash2 = hash1.clone

puts hash1[:foo]
# 'bar'

hash2[:foo] = 'surprise'

puts hash1[:foo]
# 'surprise'

puts hash1.source.equal?(hash2.source)
# true</code></pre>
<p>Hmm&#8230;that is not what we expected, right? We expected that when we clone the first options hash and modify the clone that it would not modify the original. The issue is that some things in Ruby do not get cloned when stored in other objects and one of those things is hashes. To do this right, we need to define initialize_copy for the options hash and tell it to fully clone the source hash when cloning the options hash like so:</p>
<pre><code class="ruby">class OptionsHash
  def initialize_copy(other)
    super
    @source = @source.clone
  end
end</code></pre>
<p>Now, lets run our little test again:</p>
<pre><code class="ruby">hash1 = OptionsHash.new({:foo =&gt; 'bar'})
hash2 = hash1.clone

puts hash1[:foo]
# 'bar'

hash2[:foo] = 'surprise'

puts hash1[:foo]
# 'bar'

puts hash1.source.equal?(hash2.source)
# false</code></pre>
<p>Ah, much better! Now our options hash knows how to properly clone itself and we get our expected result. Not sure who out there this will help, but I was unaware as of a few months ago so I thought I would post about it.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=FpAchjeUAVs:-TX0GvacvE8:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=FpAchjeUAVs:-TX0GvacvE8:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=FpAchjeUAVs:-TX0GvacvE8:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/FpAchjeUAVs" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:74:"http://railstips.org/blog/archives/2010/07/19/creating-duplicable-objects/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:11;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:18:"Caching With Mongo";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/O0SwjNXhez4/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4c3d28f8dabe9d4f9d000018";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-07-15T09:00:04-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-07-15T08:00:00-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:4:"gems";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:7:"mongodb";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:88:"<p>In which I introduce Bin, an ActiveSupport MongoDB cache store for Rails 2 and 3.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:5370:"<p>For those of you that do not <a href="http://twitter.com/jnunemaker">follow me on Twitter</a> or <a href="http://github.com/jnunemaker">Github</a>, a while back I released <a href="http://github.com/jnunemaker/bin">Bin</a>, an ActiveSupport MongoDB cache store. Since I have been quiet here, I thought I would talk a bit about it to help get back in the swing of things.</p>
<p>Using Bin is just like using any other AS cache store.</p>
<pre><code class="ruby">connection = Mongo::Connection.new
db = connection['bin_cache']

Rails::Initializer.run do |config|
  config.cache_store = Bin::Store.new(db)
end</code></pre>
<p>Once you have set things up, you can use all the typical Rails.cache methods.</p>
<pre><code class="ruby">Rails.cache.write('foo', 'bar')
Rails.cache.read('foo') # 'bar'

Rails.cache.fetch('foo') do
  # some expensive thing
end</code></pre>
<p>The list goes on, but in the interest of brevity, I will just link you to the <a href="http://github.com/jnunemaker/bin/blob/master/spec/bin/store_spec.rb">specs</a>. The cool thing about bin is that it supports both ActiveSupport 2 and 3 along with Ruby 1.8.7 and 1.9.1. Oh, and it supports expires with the same <span class="caps">API</span> as the memcache store.</p>
<p>That pretty much covers the basics, feel free to go kick the tires or hang around here a bit to learn how I made Bin work with AS2 and AS3.</p>
<h2>Supporting AS2/3</h2>
<p>In both ActiveSupport 2 and 3, you inhert from ActiveSupport::Cache::Store to create a new store. The difference between the version is quite subtle though. In AS3, you override the methods read, write, etc. as needed and use super with a block to get the inherited functionality. In AS2, you do the same thing, but super does not accept a block. Being that as a community we are now mugwumps (mug on Rails 2 and wumps on Rails 3), I thought it would be nice to support both.</p>
<p>In order to make this happen, I knew all I need to do was shim compatibility for Rails 2. So what I did is create a compatibility class that inherits from ActiveSupport::Cache::Store for AS3 and then if active support&#8217;s version is less than 3, I reopen the class and add in the compatibility stuff to make it work like 3. Here is the code in its entirety:</p>
<pre><code class="ruby"># encoding: UTF-8
module Bin
  class Compatibility &lt; ActiveSupport::Cache::Store
    def increment(key, amount=1)
      yield
    end

    def decrement(key, amount=1)
      yield
    end
  end

  if ActiveSupport::VERSION::STRING &lt; '3'
    class Compatibility
      def write(key, value, options=nil, &amp;block)
        super(key, value, options)
        yield
      end

      def read(key, options=nil, &amp;block)
        super
        yield
      end

      def delete(key, options=nil, &amp;block)
        super
        yield
      end

      def delete_matched(matcher, options=nil, &amp;block)
        super
        yield
      end

      def exist?(key, options=nil, &amp;block)
        super
        yield
      end
    end
  end
end</code></pre>
<p>So then Bin::Store just inherits from Compatibility:</p>
<pre><code class="ruby">module Bin
  class Store &lt; Compatibility
    # ... stuff
  end
end</code></pre>
<p>I cringe using a specific version string comparison like above, but it was simple and worked so I went with it. The last piece of the puzzle was setting up rake tasks to run the specs against different active support versions.</p>
<pre><code class="ruby">namespace :spec do
  Spec::Rake::SpecTask.new(:all) do |t|
    t.ruby_opts &lt;&lt; '-rubygems'
    t.verbose = true
  end

  task :as2 do
    sh 'ACTIVE_SUPPORT_VERSION="&lt;= 2.3.8" rake spec:all'
  end

  task :as3 do
    sh 'ACTIVE_SUPPORT_VERSION="&gt;= 3.0.0.beta3" rake spec:all'
  end
end

desc 'Runs all specs against Active Support 2 and 3'
task :spec do
  Rake::Task['spec:as2'].invoke
  Rake::Task['spec:as3'].invoke
end</code></pre>
<p>Note that I make an all task to run the specs then two distinct tasks to run against AS2 and AS3. All those tasks do is set an environment variable that I use in the test to force a particular version.</p>
<pre><code class="ruby">gem 'activesupport', ENV['ACTIVE_SUPPORT_VERSION']</code></pre>
<p>Now when I run rake, it runs the tests against a 2.3 and a 3.0+ version of ActiveSupport so I know when something goes wrong with either. No flipping gem sets or other shenanigans. As always, if you have improvements or other way so doing stuff like this, please let me know. I am here to learn people.</p>
<p>Using Bin on the last project I worked on to cache large fragments of the layout significantly reduced response times. Always fun to see numbers like that drop after a deploy!</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=O0SwjNXhez4:IZuvIToWM1k:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=O0SwjNXhez4:IZuvIToWM1k:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=O0SwjNXhez4:IZuvIToWM1k:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/O0SwjNXhez4" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:65:"http://railstips.org/blog/archives/2010/07/15/caching-with-mongo/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:12;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:19:"Mongo Scout Plugins";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/R38xasKzq7o/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4c3d1908dabe9d4674000009";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-07-13T23:05:50-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-07-13T22:00:00-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:7:"mongodb";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:5:"scout";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:100:"<p>In which I release a few scout plugins that will give you some insight into your mongo setup.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:5440:"<p>As I have stated before, <a href="http://harmonyapp.com">Harmony</a> is happily hosted with the fine folks at <a href="http://railsmachine.com">Railsmachine</a>. They use and recommend <a href="http://scoutapp.com/">Scout</a>. While I have been quite happily using several scout plugins to keep track of Harmony, including the <a href="http://scoutapp.com/plugin_urls/291-mongodb-slow-queries">MongoDB Slow Query Plugin</a>, I felt like a few things were missing. Last night and tonight, I did a bit of hacking and created a few more plugins to help round out our view into Mongo.</p>
<h2>Mongo Stats</h2>
<p>First, in order to learn how scout plugins work, I started with something simple: <a href="http://github.com/jnunemaker/scout-plugins/blob/master/mongodb/mongo_stats.rb">db stats</a>. You may or may not know that you can grab stats for your Mongo databases quite easily from the ruby driver. Using this along with scout&#8217;s plugin <span class="caps">API</span>, I wrote a Mongo Stats plugin that reports a few things about your database:</p>
<p><a href="http://github.com/jnunemaker/scout-plugins/blob/master/mongodb/mongo_stats.rb"><img src="/assets/4c3d2188dabe9d4d8200000b/mongo_stats.jpg" class="image right" alt="" /></a></p>
<ul>
	<li>The number of objects</li>
	<li>The size of your data</li>
	<li>The storage size of your data</li>
	<li>The number of indexes</li>
	<li>The size of your indexes</li>
</ul>
<p>Nothing fancy, but a good start and since keeping your indexes in <span class="caps">RAM</span> is important, having the index size reported continually will be quite handy in the future.</p>
<h2>Mongo Server Status</h2>
<p>Next, I did some digging on <a href="http://mongodb.org">mongodb.org</a> and found the <a href="http://www.mongodb.org/display/DOCS/Monitoring+and+Diagnostics">server status command</a>. I remembered that Kyle had written about <a href="http://kylebanker.com/blog/2010/03/28/does-the-driver-support-feature-x/">how to call any Mongo command from the Ruby driver</a> and a few minutes later, I had even more mongo information to peruse. The <a href="http://github.com/jnunemaker/scout-plugins/blob/master/mongodb/mongo_server_status.rb">server status plugin</a> keeps track of:</p>
<ul>
	<li>btree accesses, hits, misses, resets, and miss ratio</li>
	<li>global lock total time, lock time, and lock ratio</li>
	<li>background flushes total, total ms, average ms and last ms</li>
	<li>memory bits, resident, virtual, and mapped (if your Mongo version is up to date)</li>
</ul>
<p>Most of this information is not super helpful now, but down the road I know I will be happy I was logging it, especially when things go wrong (they always do).</p>
<p>If you are curious as to how you can call the server status command in ruby, here is the money shot:</p>
<pre><code class="ruby">db = Mongo::Connection.new.db('testing')
db.command('serverStatus' =&gt; 1)</code></pre>
<p>It returns a hash with all kinds of information. Obviously, you would have to setup your connection correctly to do this.</p>
<h2>Mongo Ops</h2>
<p>But wait! There is more! The server status command also brings back operation counts. You can get totals for commands, deletes, get mores, inserts, queries, and updates. With this information and scout&#8217;s handy <a href="http://scoutapp.com/info/creating_a_plugin#memory">remember/memory</a>, I can keep track of the numbers for these values from the last run and compare them with the current run to get up to date values for the <a href="http://github.com/jnunemaker/scout-plugins/blob/master/mongodb/mongo_ops.rb">mongo ops plugin</a>. If you aren&#8217;t giggling right now, well, there is nothing I can do for you.</p>
<p>Harmony&#8217;s numbers are not going to impress anyone right now, but I will post a few screenshots so you can get some idea of what the plugins look like before running off to install them.</p>
<p><a href="http://github.com/jnunemaker/scout-plugins/blob/master/mongodb/mongo_ops.rb"><img src="/assets/4c3d204bdabe9d497a00001b/mongo_ops.jpg" class="image full" alt="" /></a></p>
<p><a href="http://github.com/jnunemaker/scout-plugins/blob/master/mongodb/mongo_server_status.rb"><img src="/assets/4c3d204ddabe9d497a00001d/mongo_server_status.jpg" class="image full" alt="" /></a></p>
<p>With the addition of these three plugins, in cooperation with the slow query plugin, and entirely thanks to Scout, I now have lots of numbers and graphs that allow me to watch growth. Fun stuff!</p>
<p>Note that scout is not the only way you can get this information. <a href="http://mongomachine.com">MongoMachine</a> actually already shows this kind of stuff on their dashboard. Check it out if you aren&#8217;t into running Mongo yourself.</p>
<p>What are you using to keep track of Mongo?</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=R38xasKzq7o:rfj40AGLSpo:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=R38xasKzq7o:rfj40AGLSpo:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=R38xasKzq7o:rfj40AGLSpo:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/R38xasKzq7o" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:66:"http://railstips.org/blog/archives/2010/07/13/mongo-scout-plugins/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:13;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:31:"MongoMapper 0.8: Goodies Galore";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/colOUOXk9i0/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4c192166dabe9d25a0000002";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-06-16T16:03:07-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-06-16T15:00:00-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:4:"gems";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:11:"mongomapper";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:77:"<p>In which I divulge the new hotness that is version 0.8 of MongoMapper.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:8054:"<p>Let me tell you, this release has been a tough one. It is made up of <a href="http://github.com/jnunemaker/plucky/compare/0bdc4998df86febc1fcd...master">43 commits</a> to Plucky and <a href="http://github.com/jnunemaker/mongomapper/compare/69fe5a0654b0eba8b880bfe86ade599d5e9c8bf9...master">92 commits</a> to MongoMapper. Features added include a sexy query language, scopes, attr_accessible, a fancy cache key helper, a :typecast option for array/set keys, and a bajillion little improvements. Let&#8217;s run through each of them just for fun.</p>
<h2>Sexy Query Language</h2>
<p>This right here is all thanks to <a href="http://github.com/jnunemaker/plucky">plucky</a>. The goal for plucky is a fancy query language on top of MongoDB. It has been created in a such a way that other MongoDB projects (Mongoid, Candy, MongoDoc, etc.) can benefit from it if they wish. It still has a long way to go in covering edge cases and deeply nested queries, but the majority of queries one will do are covered quite nicely.</p>
<pre><code class="ruby">User.where(:age.gt =&gt; 27).sort(:age).all
User.where(:age.gt =&gt; 27).sort(:age.desc).all
User.where(:age.gt =&gt; 27).sort(:age).limit(1).all
User.where(:age.gt =&gt; 27).sort(:age).skip(1).limit(1).all</code></pre>
<p>All of the above are supported out of the box. Each query method (limit, reverse, update, skip, fields, sort, where) returns a Plucky::Query object so they can be changed together until a kicker is hit, such as all, first, last, paginate, count, size, each, etc. It is <strong>fashioned in a similar form as ARel</strong> in this manner, but more simple as ARel has to handle a lot more than just simple queries (joins, etc).</p>
<h2>Scopes</h2>
<p>The main thing I was waiting for to do scopes was to get plucky to a point where scopes would be just a sprinkling of code to merge plucky queries. Thankfully that day has finally arrived and with this latest release, you can now scope away. The code is so compact, that I figured I would drop it in here for those that are curious:</p>
<pre><code class="ruby">module MongoMapper
  module Plugins
    module Scopes
      module ClassMethods
        def scope(name, scope_options={})
          scopes[name] = lambda do |*args|
            result = scope_options.is_a?(Proc) ? scope_options.call(*args) : scope_options
            result = self.query(result) if result.is_a?(Hash)
            self.query.merge(result)
          end
          singleton_class.send :define_method, name, &amp;scopes[name]
        end

        def scopes
          read_inheritable_attribute(:scopes) || write_inheritable_attribute(:scopes, {})
        end
      end
    end
  end
end</code></pre>
<p>Yep, that is it. With that bit of code, you can now do stuff like this:</p>
<pre><code class="ruby">class User
  include MongoMapper::Document

  # plain old vanilla scopes with fancy queries
  scope :johns,   where(:name =&gt; 'John')

  # plain old vanilla scopes with hashes
  scope :bills, :name =&gt; 'Bill'

  # dynamic scopes with parameters
  scope :by_name,  lambda { |name| where(:name =&gt; name) }
  scope :by_ages,  lambda { |low, high| where(:age.gte =&gt; low, :age.lte =&gt; high) }

  # Yep, even plain old methods work as long as they return a query
  def self.by_tag(tag)
    where(:tags =&gt; tag)
  end

  # You can even make a method that returns a scope
  def self.twenties; by_ages(20, 29) end

  key :name, String
  key :tags, Array
end

# simple scopes
pp User.johns.first
pp User.bills.first

# scope with arg
pp User.by_name('Frank').first

# scope with two args
pp User.by_ages(20, 29).all

# chaining class methods on scopes
pp User.by_ages(20, 40).by_tag('ruby').all

# scope made using method that returns scope
pp User.twenties.all</code></pre>
<p>I am sure there are some edge cases, but I cannot wait to start swapping some of the code I have out for scopes. This is definitely <strong>one of the features I missed most from ActiveRecord</strong>.</p>
<h2>attr_accessible</h2>
<p>Previously, MongoMapper only supported attr_protected. The main reason was that I am lazy and someone from the community contributed the beginnings of the code. I spent some time today adding attr_accessible, so now you can really <strong>lock down your models</strong> if you want to.</p>
<pre><code class="ruby">class User
  include MongoMapper::Document

  attr_accessible :first_name, :last_name, :email

  key :first_name, String
  key :last_name, String
  key :email, String
  key :admin, Boolean, :default =&gt; false
end</code></pre>
<p>Based on the example above, only first_name, last_name and email can be assigned when using mass assignment, such as in <code>.new</code> or <code>#update_attributes</code>.</p>
<h2>Cache Key</h2>
<p>On a recent MongoMapper project, I had to some caching. This led me to create <a href="http://github.com/jnunemaker/bin">bin</a>, a MongoDB ActiveSupport cache store. The first thing you notice when you start to cache stuff is that you need a key to name the cached object or fragment. I dug around in AR and discovered the cache_key method. MongoMapper&#8217;s cache_key works the same with a little twist. You can <strong>pass arguments</strong> to it and they will <strong>become suffixes</strong> on the cache key. Lets look at an example:</p>
<pre><code class="ruby">class User
  include MongoMapper::Document
end

User.new.cache_key # =&gt; "User/new"
User.create.cache_key # =&gt; "User/:id"
User.create.cache_key(:foo, :bar) # =&gt; "User/:id/foo/bar"</code></pre>
<p>It should also be noted that if the User model <strong>has an updated_at key</strong>, that will be appended after the id like so User/:id-:timestamp. This addition is definitely going to clean up some code on a project of mine.</p>
<h2>Typecasting Array/Set values</h2>
<p>A common idiom in MongoDB modeling is to use Array keys for many to many type relationships. You have a User model and a Site model. Sites can have many Users and Users can have many Sites. Typically, I make a key :user_ids, Array and store the ids of each user that has access to the site.</p>
<p>When this is done from web forms, everything comes in as a string, so you have to typecast those strings to object ids. The new :typecast option wraps this up in a single key/value.</p>
<pre><code class="ruby">class Site
  include MongoMapper::Document
  key :user_ids, Array, :typecast =&gt; 'ObjectId'
end</code></pre>
<p>Now, whenever user_ids is assigned, each value gets typecast to an ObjectId. This will work with <strong>any class that defines the to_mongo class method</strong>, which means you can use it with custom types as well.</p>
<h2>Conclusion</h2>
<p>I learned <strong>more about Ruby</strong> while working on this release of MongoMapper than probably any other period in my brief history. I really feel like this release brings MongoMapper to the forefront of MongoDB/Ruby object mappers.</p>
<p>All the typical dressings are now in place and with a few more tweaks, I can smell 1.0. Hope you all find this stuff useful and as always, if you don&#8217;t, that is ok because I am enjoying the heck out of working on this stuff. :)</p>
<p>Oh, and if all of this above did not excite you, know that the <strong>new MongoMapper site</strong>, including full documentation, is <a href="http://frst.in/~mLh">well underway</a> and should be ready for consumption soon. Hooray!</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=colOUOXk9i0:-Hoig-mmHO0:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=colOUOXk9i0:-Hoig-mmHO0:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=colOUOXk9i0:-Hoig-mmHO0:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/colOUOXk9i0" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:76:"http://railstips.org/blog/archives/2010/06/16/mongomapper-08-goodies-galore/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:14;a:6:{s:4:"data";s:68:"
      
      
      
      
      
      
      
      
      
    ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:2:{s:27:"http://www.w3.org/2005/Atom";a:9:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:14:"RailsConf 2010";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"href";s:56:"http://feedproxy.google.com/~r/railstips/~3/Bmk-7OfO06k/";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:2:"id";a:1:{i:0;a:5:{s:4:"data";s:24:"4c15a492dabe9d2743000052";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"updated";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-06-16T14:47:05-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"published";a:1:{i:0;a:5:{s:4:"data";s:25:"2010-06-16T12:00:00-04:00";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"term";s:11:"conferences";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"summary";a:1:{i:0;a:5:{s:4:"data";s:55:"<p>In which I talk a bit about RailsConf 2010. Duh.</p>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"content";a:1:{i:0;a:5:{s:4:"data";s:2882:"<p>Unless you were born in a barn, you probably know that last week was RailsConf. Let me tell you folks, we had a blast. Several of the locals (Northern Indiana represent!) and I loaded up in a Dodge Sprinter and road tripped to Baltimore.</p>
<p><a href="http://www.flickr.com/photos/johnnunemaker/4703489469/" title="Pit Stop by jnunemaker, on Flickr"><img src="http://farm5.static.flickr.com/4053/4703489469_854b1fb758.jpg" width="450" class="image"  alt="Pit Stop" /></a></p>
<p>We played Halo, watched movies, and a good deal of coding happened as well.</p>
<h2>Speaking</h2>
<p>I have submitted presentations to every RailsConf and nearly every RubyConf since 2007 and rejection was my middle name. This year, I finally made the cut. My talk was titled &#8220;Don&#8217;t Repeat Yourself, Repeat Others&#8221;. The basic gist was how to improve.</p>
<p>You can hear the <a href="http://ruby5.envylabs.com/episodes/85-episode-83-june-8-2010/stories/715-john-nunemaker">2 minute summary</a> on Ruby5. Based on feedback, I think it went really well, though not all are use to my speedy style. Below are the slides for those that have not perused them yet. Beware, there is a lot of code. :)</p>
<p><object id="__sse4443379" width="425" height="355"><param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=dontrepeatyourselfrepeatothers-100608134812-phpapp02&stripped_title=dont-repeat-yourself-repeat-others" /><param name="allowFullScreen" value="true"/><param name="allowScriptAccess" value="always"/><embed name="__sse4443379" src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=dontrepeatyourselfrepeatothers-100608134812-phpapp02&stripped_title=dont-repeat-yourself-repeat-others" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="355"></embed></object></p>
<p><a href="http://www.youtube.com/watch?v=-QWHkcCP3tA">Gary V</a> and <a href="http://www.youtube.com/watch?v=fV-phU9m9kg">Derek Sivers</a> both had great keynotes. Definitely watch them. This year was really fun. The speakers seemed of higher quality than in the past and I really met a lot of people (which is what it is all about anyway). Glad to be home though.</p><div class="feedflare">
<a href="http://feeds.feedburner.com/~ff/railstips?a=Bmk-7OfO06k:ATsOuN2DqFo:yIl2AUoC8zA"><img src="http://feeds.feedburner.com/~ff/railstips?d=yIl2AUoC8zA" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=Bmk-7OfO06k:ATsOuN2DqFo:dnMXMwOfBR0"><img src="http://feeds.feedburner.com/~ff/railstips?d=dnMXMwOfBR0" border="0"></img></a> <a href="http://feeds.feedburner.com/~ff/railstips?a=Bmk-7OfO06k:ATsOuN2DqFo:7Q72WNTAKBA"><img src="http://feeds.feedburner.com/~ff/railstips?d=7Q72WNTAKBA" border="0"></img></a>
</div><img src="http://feeds.feedburner.com/~r/railstips/~4/Bmk-7OfO06k" height="1" width="1"/>";s:7:"attribs";a:1:{s:0:"";a:1:{s:4:"type";s:4:"html";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:6:"author";a:1:{i:0;a:6:{s:4:"data";s:16:"
        
      ";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"name";a:1:{i:0;a:5:{s:4:"data";s:14:"John Nunemaker";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:1:{s:8:"origLink";a:1:{i:0;a:5:{s:4:"data";s:61:"http://railstips.org/blog/archives/2010/06/16/railsconf-2010/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:42:"http://rssnamespace.org/feedburner/ext/1.0";a:3:{s:4:"info";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:1:{s:3:"uri";s:9:"railstips";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:14:"emailServiceId";a:1:{i:0;a:5:{s:4:"data";s:9:"railstips";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:18:"feedburnerHostname";a:1:{i:0;a:5:{s:4:"data";s:28:"http://feedburner.google.com";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://www.w3.org/2003/01/geo/wgs84_pos#";a:2:{s:3:"lat";a:1:{i:0;a:5:{s:4:"data";s:9:"41.650672";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"long";a:1:{i:0;a:5:{s:4:"data";s:10:"-86.160028";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}}s:4:"type";i:512;s:7:"headers";a:11:{s:12:"content-type";s:23:"text/xml; charset=UTF-8";s:4:"etag";s:27:"89V4CFO+s5FjUJnwEEpH2VzjAuU";s:13:"last-modified";s:29:"Tue, 22 Feb 2011 13:53:35 GMT";s:16:"content-encoding";s:4:"gzip";s:17:"transfer-encoding";s:7:"chunked";s:4:"date";s:29:"Tue, 22 Feb 2011 14:22:31 GMT";s:7:"expires";s:29:"Tue, 22 Feb 2011 14:22:31 GMT";s:13:"cache-control";s:18:"private, max-age=0";s:22:"x-content-type-options";s:7:"nosniff";s:16:"x-xss-protection";s:13:"1; mode=block";s:6:"server";s:3:"GSE";}s:5:"build";s:14:"20110128231735";}