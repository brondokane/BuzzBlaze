a:4:{s:5:"child";a:1:{s:0:"";a:1:{s:3:"rss";a:1:{i:0;a:6:{s:4:"data";s:3:"


";s:7:"attribs";a:1:{s:0:"";a:1:{s:7:"version";s:3:"2.0";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:1:{s:0:"";a:1:{s:7:"channel";a:1:{i:0;a:6:{s:4:"data";s:50:"
	
	
	
	
	
	
	
	
	
		
		
		
		
		
		
		
		
		
		
	";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:3:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:41:"CodeUtopia - The blog of Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:26:"http://codeutopia.net/blog";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:61:"Software development with a focus on web-related technologies";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:13:"lastBuildDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Sun, 20 Feb 2011 18:02:45 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"language";a:1:{i:0;a:5:{s:4:"data";s:2:"en";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:9:"generator";a:1:{i:0;a:5:{s:4:"data";s:27:"http://wordpress.org/?v=3.0";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"item";a:10:{i:0;a:6:{s:4:"data";s:44:"
		
		
		
		
		
				
		

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:32:"Using spatial data in Doctrine 2";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:71:"http://codeutopia.net/blog/2011/02/19/using-spatial-data-in-doctrine-2/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:80:"http://codeutopia.net/blog/2011/02/19/using-spatial-data-in-doctrine-2/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Sat, 19 Feb 2011 13:49:22 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:11:"Programming";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:8:"Doctrine";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=491";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:331:"In this post I&#8217;ll introduce you to extending Doctrine 2 to provide ways to use custom data types and DQL functions. We needed a simple way to store locations and calculate distances between points on maps and some other stuff for Wantlet. Since we are using MySQL, we decided to use MySQL&#8217;s Spatial Extensions for [...]";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:35956:"<p>In this post I&#8217;ll introduce you to extending Doctrine 2 to provide ways to use custom data types and DQL functions.</p>
<p>We needed a simple way to store locations and calculate distances between points on maps and some other stuff for <a href="http://www.wantlet.com">Wantlet</a>. Since we are using MySQL, we decided to use MySQL&#8217;s Spatial Extensions for it since they seemed suitable.</p>
<p>We&#8217;re using Doctrine 2 as the ORM layer in the application, but it didn&#8217;t have any sort of data types or functionality for storing and operating on spatial data. Thankfully though, Doctrine 2 is very easy to extend to accomodate new data types and new DQL functions. It did require a small workaround for an issue not yet addressed in it, but in the end it worked out quite well. </p>
<p><span id="more-491"></span></p>
<h3>Basic MySQL spatial data functionality</h3>
<p>MySQL has a range of <a href="http://dev.mysql.com/doc/refman/5.0/en/spatial-extensions.html">functionality for spatial data</a>. We only needed to store points and calculate distances between them, so that&#8217;s what I&#8217;ll be focusing on here.</p>
<p>MySQL has a data type called <code>POINT</code> which stores an x, y sort of value. The function <code>DISTANCE</code> should work for calculating distances between points, but apparently it doesn&#8217;t for whatever reason, so I worked around the issue by using <code>GLength</code> and <code>LineString</code>.</p>
<h3>Extending Doctrine 2</h3>
<p>To be able to use these features in Doctrine 2, we need to add a new data type to Doctrine&#8217;s DBAL and some custom functions to the EntityManager&#8217;s configuration for extending DQL.</p>
<h3>Adding the point database type</h3>
<p>First, let&#8217;s check out the code for adding the <code>POINT</code> type:</p>
<p>First, we have the <code>Point</code> class, which is used to represent columns with the <code>POINT</code> type. It&#8217;s quite simple, just some getters and setters:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #000000; font-weight: bold;">namespace</span> Wantlet\ORM<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #009933; font-style: italic;">/**
 * Point object for spatial mapping
 */</span>
<span style="color: #000000; font-weight: bold;">class</span> Point <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000088;">$latitude</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000088;">$longitude</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> __construct<span style="color: #009900;">&#40;</span><span style="color: #000088;">$latitude</span><span style="color: #339933;">,</span> <span style="color: #000088;">$longitude</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">latitude</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$latitude</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">longitude</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$longitude</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> setLatitude<span style="color: #009900;">&#40;</span><span style="color: #000088;">$x</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">latitude</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$x</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getLatitude<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">latitude</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> setLongitude<span style="color: #009900;">&#40;</span><span style="color: #000088;">$y</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">longitude</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$y</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getLongitude<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">longitude</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> __toString<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #666666; font-style: italic;">//Output from this is used with POINT_STR in DQL so must be in specific format</span>
        <span style="color: #b1b100;">return</span> <span style="color: #990000;">sprintf</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'POINT(%f %f)'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">latitude</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">longitude</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p><a href="https://github.com/jhartikainen/doctrine2-spatial/blob/master/Wantlet/ORM/Point.php">Point.php</a> on GitHub.</p>
<p>The interesting part in this is the <code>__toString</code> function. I&#8217;ll explain it later in this post.</p>
<p>Next, we need a mapping type for Doctrine. Doctrine helpfully provides a base class we can extend to provide custom types:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #000000; font-weight: bold;">namespace</span> Wantlet\ORM<span style="color: #339933;">;</span>
&nbsp;
use Doctrine\DBAL\Types\Type<span style="color: #339933;">;</span>
use Doctrine\DBAL\Platforms\AbstractPlatform<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #009933; font-style: italic;">/**
 * Mapping type for spatial POINT objects
 */</span>
<span style="color: #000000; font-weight: bold;">class</span> PointType <span style="color: #000000; font-weight: bold;">extends</span> Type <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">const</span> POINT <span style="color: #339933;">=</span> <span style="color: #0000ff;">'point'</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #009933; font-style: italic;">/**
     * Gets the name of this type.
     *
     * @return string
     */</span>
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getName<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">POINT</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #009933; font-style: italic;">/**
     * Gets the SQL declaration snippet for a field of this type.
     *
     * @param array $fieldDeclaration The field declaration.
     * @param AbstractPlatform $platform The currently used database platform.
     */</span>
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getSQLDeclaration<span style="color: #009900;">&#40;</span><span style="color: #990000;">array</span> <span style="color: #000088;">$fieldDeclaration</span><span style="color: #339933;">,</span> AbstractPlatform <span style="color: #000088;">$platform</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #0000ff;">'POINT'</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> convertToPHPValue<span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #339933;">,</span> AbstractPlatform <span style="color: #000088;">$platform</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #666666; font-style: italic;">//Null fields come in as empty strings</span>
        <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span> <span style="color: #339933;">==</span> <span style="color: #0000ff;">''</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #b1b100;">return</span> <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
&nbsp;
        <span style="color: #000088;">$data</span> <span style="color: #339933;">=</span> <span style="color: #990000;">unpack</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'x/x/x/x/corder/Ltype/dlat/dlon'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #000000; font-weight: bold;">new</span> \Wantlet\ORM\Point<span style="color: #009900;">&#40;</span><span style="color: #000088;">$data</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'lat'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #000088;">$data</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'lon'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> convertToDatabaseValue<span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #339933;">,</span> AbstractPlatform <span style="color: #000088;">$platform</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span> <span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #b1b100;">return</span> <span style="color: #990000;">pack</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'xxxxcLdd'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'0'</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> <span style="color: #000088;">$value</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">getLatitude</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #000088;">$value</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">getLongitude</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p><a href="https://github.com/jhartikainen/doctrine2-spatial/blob/master/Wantlet/ORM/PointType.php">PointType.php</a> on GitHub.</p>
<p>The main functionality of this class is to convert points to and from the format MySQL uses for them. We use <code>pack</code> and <code>unpack</code> because the format is in binary. From the user&#8217;s point of view, he can simply work with <code>Point</code> objects which simplifies it a lot.</p>
<p>You may notice the <code>$platform</code> variable in places, which is completely unused. This is something you can use to determine the type of database in question, if the same functionality needs to be done differently on a per-database basis. However, in this case, we only needed it for MySQL so everything is hardcoded in a format that works in it.</p>
<h3>Using the new POINT type</h3>
<p>First, the <code>PointType</code> must be added to DBAL in your configuration:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;">Doctrine\DBAL\Types\Type<span style="color: #339933;">::</span><span style="color: #004000;">addType</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'point'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'Wantlet\ORM\PointType'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<p>After this, you can use the type with entities:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #009933; font-style: italic;">/**
 * @Entity
 */</span>
<span style="color: #000000; font-weight: bold;">class</span> ExampleEntity <span style="color: #009900;">&#123;</span>
    <span style="color: #009933; font-style: italic;">/**
     * @Column(type=&quot;point&quot;)
     */</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000088;">$somePoint</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> setSomePoint<span style="color: #009900;">&#40;</span>\Wantlet\ORM\Point <span style="color: #000088;">$point</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">somePoint</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$point</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getSomePoint<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">somePoint</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>As you can see from the setter, the <code>somePoint</code> property will appear as a <code>Point</code> object &#8211; Doctrine 2 will automatically create objects of that type for it, and convert objects from that type back into database values &#8211; very very convenient!</p>
<p>A simple example:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000088;">$ent</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> ExampleEntity<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$point</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> \Wantlet\Entity\Point<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">10</span><span style="color: #339933;">,</span> <span style="color:#800080;">20.5</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000088;">$ent</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">setSomePoint</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$point</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000088;">$em</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">persist</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$ent</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$em</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">flush</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<h3>Adding functions for working with points</h3>
<p>With the classes defined above, Doctrine 2 can now handle databases with points in them. It can also handle mapping columns in entities to points. </p>
<p>However, we can&#8217;t use points with DQL yet, and we also can&#8217;t do any typical queries either, such as getting all points within a specific distance of another point.</p>
<p>For this, we need to add some new DQL functions:</p>
<ul>
<li><code>DISTANCE</code>, for distances between two points</li>
<li><code>POINT_STR</code>, for converting <code>Point</code> objects into format SQL can handle</li>
</ul>
<p>Let&#8217;s first look at <code>POINT_STR</code>, which will allow us to use <code>Point</code>s in DQL&#8230;</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #000000; font-weight: bold;">namespace</span> Wantlet\ORM<span style="color: #339933;">;</span>
&nbsp;
use Doctrine\ORM\Query\AST\Functions\FunctionNode<span style="color: #339933;">;</span>
use Doctrine\ORM\Query\Lexer<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #009933; font-style: italic;">/**
 * POINT_STR function for querying using Point objects as parameters
 *
 * Usage: POINT_STR(:param) where param should be mapped to $point where $point is Wantlet\ORM\Point
 *        without any special typing provided (eg. so that it gets converted to string)
 */</span>
<span style="color: #000000; font-weight: bold;">class</span> PointStr <span style="color: #000000; font-weight: bold;">extends</span> FunctionNode <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000088;">$arg</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getSql<span style="color: #009900;">&#40;</span>\Doctrine\ORM\Query\SqlWalker <span style="color: #000088;">$sqlWalker</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #0000ff;">'GeomFromText('</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">arg</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">dispatch</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$sqlWalker</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">')'</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> parse<span style="color: #009900;">&#40;</span>\Doctrine\ORM\Query\Parser <span style="color: #000088;">$parser</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">match</span><span style="color: #009900;">&#40;</span>Lexer<span style="color: #339933;">::</span><span style="color: #004000;">T_IDENTIFIER</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">match</span><span style="color: #009900;">&#40;</span>Lexer<span style="color: #339933;">::</span><span style="color: #004000;">T_OPEN_PARENTHESIS</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">arg</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">ArithmeticPrimary</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">match</span><span style="color: #009900;">&#40;</span>Lexer<span style="color: #339933;">::</span><span style="color: #004000;">T_CLOSE_PARENTHESIS</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #009900;">&#125;</span></pre></div></div>

<p><a href="https://github.com/jhartikainen/doctrine2-spatial/blob/master/Wantlet/ORM/PointStr.php">PointStr.php</a> on GitHub.</p>
<p>Why do we need this function? This is because, as far as I know, SQL and Doctrine do not understand how to represent binary values in queries. As you may recall, the <code>PointType</code> class maps the point columns into binary.</p>
<p>We can work around this issue by using <code>GeomFromText</code> &#8211; it takes a string such as <code>'POINT(10 20)'</code> and converts it into the respective spatial datatype.</p>
<p>Remember the <code>__toString</code> in the point type class?</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> __toString<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #666666; font-style: italic;">//Output from this is used with POINT_STR in DQL so must be in specific format</span>
    <span style="color: #b1b100;">return</span> <span style="color: #990000;">sprintf</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'POINT(%f %f)'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">latitude</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">longitude</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>As you can see, we output exactly the kind of strings from here.</p>
<p>Since Doctrine 2&#8242;s default handling of parameters in queries is to simply convert them into strings, we can use <code>POINT_STR</code> in combination with <code>__toString</code> to make it easy to use points in DQL:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000088;">$query</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$em</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">createQuery</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'SELECT e FROM ExampleEntity e WHERE e.somePoint = POINT_STR(:point)'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000088;">$point</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> \Wantlet\Entity\Point<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$query</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">setParameter</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'point'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$point</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000088;">$query</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">execute</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<p>Now the queries with points work pretty much like any other query &#8211; you just need to remember to use <code>POINT_STR</code>.</p>
<p>Now, let&#8217;s add the <code>DISTANCE</code> function:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #000000; font-weight: bold;">namespace</span> Wantlet\ORM<span style="color: #339933;">;</span>
&nbsp;
use Doctrine\ORM\Query\AST\Functions\FunctionNode<span style="color: #339933;">;</span>
use Doctrine\ORM\Query\Lexer<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #009933; font-style: italic;">/**
 * DQL function for calculating distances between two points
 *
 * Example: DISTANCE(foo.point, POINT_STR(:param))
 */</span>
<span style="color: #000000; font-weight: bold;">class</span> Distance <span style="color: #000000; font-weight: bold;">extends</span> FunctionNode <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000088;">$firstArg</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000088;">$secondArg</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getSql<span style="color: #009900;">&#40;</span>\Doctrine\ORM\Query\SqlWalker <span style="color: #000088;">$sqlWalker</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #666666; font-style: italic;">//Need to do this hacky linestring length thing because</span>
        <span style="color: #666666; font-style: italic;">//despite what MySQL manual claims, DISTANCE isn't actually implemented...</span>
        <span style="color: #b1b100;">return</span> <span style="color: #0000ff;">'GLength(LineString('</span> <span style="color: #339933;">.</span>
               <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">firstArg</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">dispatch</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$sqlWalker</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span>
               <span style="color: #0000ff;">', '</span> <span style="color: #339933;">.</span>
               <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">secondArg</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">dispatch</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$sqlWalker</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span>
           <span style="color: #0000ff;">'))'</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> parse<span style="color: #009900;">&#40;</span>\Doctrine\ORM\Query\Parser <span style="color: #000088;">$parser</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">match</span><span style="color: #009900;">&#40;</span>Lexer<span style="color: #339933;">::</span><span style="color: #004000;">T_IDENTIFIER</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">match</span><span style="color: #009900;">&#40;</span>Lexer<span style="color: #339933;">::</span><span style="color: #004000;">T_OPEN_PARENTHESIS</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">firstArg</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">ArithmeticPrimary</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">match</span><span style="color: #009900;">&#40;</span>Lexer<span style="color: #339933;">::</span><span style="color: #004000;">T_COMMA</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">secondArg</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">ArithmeticPrimary</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$parser</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">match</span><span style="color: #009900;">&#40;</span>Lexer<span style="color: #339933;">::</span><span style="color: #004000;">T_CLOSE_PARENTHESIS</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p><a href="https://github.com/jhartikainen/doctrine2-spatial/blob/master/Wantlet/ORM/Distance.php">Distance.php</a> on GitHub.</p>
<p>This class allows us to use a new DQL function called <code>DISTANCE</code> to calculate distances between points. It&#8217;s converted into SQL as <code>GLength(LineString(arg1, arg2))</code> because it achieves the same result as the SQL <code>DISTANCE</code> function, which for some reason doesn&#8217;t seem to function in MySQL.</p>
<p>Using this function is simple, for example to get all entities within a certain distance of another point:<br />
<code>SELECT e FROM ExampleEntity e WHERE DISTANCE(e.somePoint, POINT_STR(:point)) < 5</code></p>
<h3>Enabling the new DQL functions in Doctrine</h3>
<p>To use the new DQL functions, we need to add them when configuring the EntityManager:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">//Assuming $config is a Doctrine\ORM\Configuration object used to configure the EM</span>
<span style="color: #000088;">$config</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">addCustomNumericFunction</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'DISTANCE'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'Wantlet\ORM\Distance'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$config</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">addCustomNumericFunction</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'POINT_STR'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'Wantlet\ORM\PointStr'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<h3>Conclusion</h3>
<p>As you can see, Doctrine 2 is quite easy to extend. This is another reason why it's definitely the best ORM tool for PHP in my opinion.</p>
<p>All the classes shown in this post are available on my <a href="https://github.com/jhartikainen/doctrine2-spatial">GitHub repo doctrine2-spatial</a>.</p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:76:"http://codeutopia.net/blog/2011/02/19/using-spatial-data-in-doctrine-2/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:1:"4";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:1;a:6:{s:4:"data";s:44:"
		
		
		
		
		
				
		

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:28:"What was the point of XHTML?";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:66:"http://codeutopia.net/blog/2011/02/03/what-was-the-point-of-xhtml/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:75:"http://codeutopia.net/blog/2011/02/03/what-was-the-point-of-xhtml/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Thu, 03 Feb 2011 15:41:28 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:11:"Programming";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:3:"Web";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=480";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:318:"XHTML was the fad for a while &#8211; you were a bad coder if your markup wasn&#8217;t valid XHTML. Now it&#8217;s fading out. Giorgio Sironi&#8217;s recent look at what happened to XHTML got me thinking: What was the point of all this? Why was XHTML useful, or was it? XHTML educated developers Before XHTML, it [...]";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:2139:"<p>XHTML was the fad for a while &#8211; you were a bad coder if your markup wasn&#8217;t valid XHTML. Now it&#8217;s <em>fad</em>ing out. </p>
<p>Giorgio Sironi&#8217;s recent look at <a href="http://css.dzone.com/articles/where-has-xhtml-gone">what happened to XHTML</a> got me thinking: What was the point of all this? Why was XHTML useful, or was it?</p>
<p><span id="more-480"></span></p>
<h3>XHTML educated developers</h3>
<p>Before XHTML, it was okay to be loose and sloppy. The browser is going to fix it!</p>
<p>At least for myself, with XHTML came validators and people generally seemed to mind that their documents actually were properly validated according to spec. The fact that if you served XHTML with the correct mimetype, it actually made some browsers display an XML validation error and nothing more, might also have helped.</p>
<p>XHTML was like that strict math teacher you had in elementary school. A tiny mistake there and oh boy now you&#8217;ve done it. (Any resemblance to any actual teachers is completely accidental)</p>
<h3>XHTML brought forwards the importance of separating structure from presentation</h3>
<p>Since XHTML deprecated tags such as <code>&lt;b&gt;</code>, <code>&lt;i&gt;</code> and <code>&lt;font&gt;</code>, it made for yet more reasons to use CSS. </p>
<h3>XHTML&#8217;s legacy: Valid documents</h3>
<p>Put everything together and XHTML really made way for enabling us to write better web applications.</p>
<p>Good markup is easier to manipulate, both in CSS and JavaScript.<br />
The reduced complexity of markup improves load speeds<br />
The use of CSS instead of tags allowed for better, uniform, styling of entire sites/apps</p>
<p>Overall, I think XHTML brought increased awareness of writing good markup.</p>
<h3>A new enemy</h3>
<p>With the situation of style vs markup improved, there is now a new enemy&#8230;</p>
<p>Spanitis and divitis.</p>
<p>The pointless use of divs and spans, when you don&#8217;t really need them. Will HTML5, with its new semantic elements, improve this situation like XHTML improved styling and validation?</p>
<p>Leave your thoughts in the comments!</p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:71:"http://codeutopia.net/blog/2011/02/03/what-was-the-point-of-xhtml/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:1:"8";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:2;a:6:{s:4:"data";s:41:"
		
		
		
		
		
				

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:10:"Hello 2011";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:49:"http://codeutopia.net/blog/2011/01/24/hello-2011/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:58:"http://codeutopia.net/blog/2011/01/24/hello-2011/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Mon, 24 Jan 2011 19:21:00 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:1:{i:0;a:5:{s:4:"data";s:7:"general";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=473";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:340:"So what&#8217;s up? It&#8217;s 2011! Well yes, it has been 2011 for almost a month already, but I&#8217;ve been kinda busy with stuff. Here&#8217;s some statistics from Codeutopia in 2010 and what interesting things have been going on lately. Blog statistics for 2010 Compared to 2009, the year 2010 brought a slight drop in visitors, [...]";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:2797:"<p>So what&#8217;s up? It&#8217;s 2011! Well yes, it has been 2011 for almost a month already, but I&#8217;ve been kinda busy with stuff.</p>
<p>Here&#8217;s some statistics from Codeutopia in 2010 and what interesting things have been going on lately.</p>
<p><span id="more-473"></span></p>
<h3>Blog statistics for 2010</h3>
<p>Compared to 2009, the year 2010 brought a slight drop in visitors, with a total of 193 005 visits and 266 067 page views. This is probably mostly due to me not posting three times a week like I used to before.</p>
<p>However I hope the quality of content has been as good (or better).</p>
<p>The top 5 posts for 2010:</p>
<ul>
<li><a href="http://codeutopia.net/blog/2009/02/06/zend_acl-part-1-misconceptions-and-simple-acls/">Zend Acl part 1: Misconceptions and simple ACLs</a></li>
<li><a href="http://codeutopia.net/blog/2009/02/18/zend_acl-part-3-creating-and-storing-dynamic-acls/">Zend Acl part 3: Creating and storing dynamic ACLs</a></li>
<li><a href="http://codeutopia.net/blog/2009/03/02/handling-errors-in-zend-framework/">Handling errors in Zend Framework</a></li>
<li><a href="http://codeutopia.net/blog/2009/02/11/zend_acl-part-2-different-roles-and-resources-more-on-access/">Zend Acl part 2: Different roles and more on access</a></li>
<li><a href="http://codeutopia.net/blog/2010/01/28/6-programming-project-mistakes-you-should-avoid/">6 programming project mistakes you should avoid</a></li>
</ul>
<p>So for the most part it seems the ZF related content is most popular. Compared to <a href="http://codeutopia.net/blog/2009/12/29/best-of-2009/">last year&#8217;s top 5</a>, the posts are nearly the same.</p>
<h3>What will 2011 bring?</h3>
<p>So far it looks like 2011 is going to be an interesting year.</p>
<p>Late in 2010, I got a new job, working as Senior Developer at a finnish web startup called CasCard. </p>
<p>Recently, we launched our new web service, <a href="http://www.wantlet.com">Wantlet</a>. It&#8217;s a &#8220;social shopping&#8221; service, and it&#8217;s available in english so be sure to check it out! It requires Facebook based login, but I promise it won&#8217;t post anything on your wall unless you want.</p>
<p>The current version of Wantlet is a beta, and we are still in progress of ironing out bugs and polishing the user experience. Feel free to leave any feedback via the UserVoice Feedback link on each page.</p>
<p>The service is based on Zend Framework, Doctrine 2 and Dojo. I can probably talk a bit about the architecture and other stuff if there is interest in hearing about it. We are also planning an API anyone can use to access the data and create mashups or other stuff.</p>
<p><br/><br/><br />
As for this blog, I plan to continue posting. I hope to keep some sort of a schedule, but we&#8217;ll see.</p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:54:"http://codeutopia.net/blog/2011/01/24/hello-2011/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:1:"4";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:3;a:6:{s:4:"data";s:44:"
		
		
		
		
		
				
		

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:67:"Link: Refactoring a service class for better separation of concerns";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:105:"http://codeutopia.net/blog/2010/12/15/link-refactoring-a-service-class-for-better-separation-of-concerns/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:114:"http://codeutopia.net/blog/2010/12/15/link-refactoring-a-service-class-for-better-separation-of-concerns/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Wed, 15 Dec 2010 11:21:49 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:11:"Programming";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:28:"Software design/architecture";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=466";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:216:"RV David has an interesting post on his blog about refactoring a service class for better separation of concerns compliancy. I also left some ideas in the comments as I&#8217;m currently working on something similar.";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:335:"<p>RV David has an interesting post on his blog about <a href="http://www.rvdavid.net/how-i-refactored-my-service-class-to-be-separation-of-concerns-compliant/">refactoring a service class for better separation of concerns compliancy</a>. I also left some ideas in the comments as I&#8217;m currently working on something similar.</p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:110:"http://codeutopia.net/blog/2010/12/15/link-refactoring-a-service-class-for-better-separation-of-concerns/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:1:"1";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:4;a:6:{s:4:"data";s:44:"
		
		
		
		
		
				
		

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:57:"How to create Doctrine 1 -style Soft-Delete in Doctrine 2";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:95:"http://codeutopia.net/blog/2010/12/04/how-to-create-doctrine-1-style-soft-delete-in-doctrine-2/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:104:"http://codeutopia.net/blog/2010/12/04/how-to-create-doctrine-1-style-soft-delete-in-doctrine-2/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Sat, 04 Dec 2010 17:48:39 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:11:"Programming";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:8:"Doctrine";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=455";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:346:"Doctrine 1 has the concept of behaviors which you could add to your models. One of these was the soft-delete behavior, which allowed you to &#8220;delete&#8221; records without really deleting them. Doctrine 2 does not have behaviors due to various reasons. However, I needed a way to have a model which worked like soft-delete. Let&#8217;s [...]";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:12141:"<p>Doctrine 1 has the concept of behaviors which you could add to your models. One of these was the soft-delete behavior, which allowed you to &#8220;delete&#8221; records without really deleting them.</p>
<p>Doctrine 2 <a href="http://www.doctrine-project.org/blog/doctrine2-behaviours-nutshell">does not have behaviors due to various reasons</a>. However, I needed a way to have a model which worked like soft-delete.</p>
<p>Let&#8217;s see one approach to creating such behavior in Doctrine 2.</p>
<p><span id="more-455"></span></p>
<h3>Soft-delete basics</h3>
<p>Simply put, all we need for soft-delete is a flag in the table &#8211; the deleted flag. This will be used to tell whether a record has been deleted or not.</p>
<p>In practice it&#8217;s a bit more involved than that, as you need to make sure all your queries work accordingly. Queries which fetch listings must make sure to only fetch lists of things that haven&#8217;t been deleted and queries deleting things must be sure to not execute any DELETE statements.</p>
<h3>Doctrine 2 custom repositories</h3>
<p>The most straightforward way to create a entity type in Doctrine 2 which works in a soft-delete style manner is to create a custom repository.</p>
<p>The idea is that you should access your database through the repository. This is similar to other approaches for abstracting database access: The repository hides the detail of what is used to access the DB, and thus you can easily change the plumbing later if needed.</p>
<p>By using the repository we can also inject custom behavior in queries, such as soft-delete.</p>
<h3>Creating a soft-delete enabled repository</h3>
<p>Let&#8217;s say we have an example entity called&#8230; Example. Creative, don&#8217;t you think?</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #009933; font-style: italic;">/**
 * @Entity(repositoryClass=&quot;ExampleRepository&quot;)
 */</span>
<span style="color: #000000; font-weight: bold;">class</span> Example <span style="color: #009900;">&#123;</span>
    <span style="color: #666666; font-style: italic;">//Let's assume there's some fields here</span>
&nbsp;
    <span style="color: #009933; font-style: italic;">/**
     * @Column(type=&quot;boolean&quot;)
     */</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000088;">$deleted</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> delete<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">deleted</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">true</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> isDeleted<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">deleted</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>First, note we declared a custom repository class in the entity annotation. Then, we have a boolean mapping for a deleted field, a method to mark the entity deleted and a method to get the deleted value. You might also want to add a method for undeleting entities if you find it necessary.</p>
<p>Next, we&#8217;ll need the repository:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">class</span> ExampleRepository <span style="color: #000000; font-weight: bold;">extends</span> \Doctrine\ORM\EntityRepository <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> findBy<span style="color: #009900;">&#40;</span><span style="color: #990000;">array</span> <span style="color: #000088;">$criteria</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> findOneBy<span style="color: #009900;">&#40;</span><span style="color: #990000;">array</span> <span style="color: #000088;">$criteria</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> find<span style="color: #009900;">&#40;</span><span style="color: #000088;">$id</span><span style="color: #339933;">,</span> <span style="color: #000088;">$lockMode</span> <span style="color: #339933;">=</span> \Doctrine\DBAL\LockMode<span style="color: #339933;">::</span><span style="color: #004000;">NONE</span><span style="color: #339933;">,</span> <span style="color: #000088;">$lockVersion</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>The three methods in the repository will override the default finders. This will be enough to make the repository always return non-deleted entities by default.</p>
<p>Let&#8217;s look at how to implement the functions:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> findBy<span style="color: #009900;">&#40;</span><span style="color: #990000;">array</span> <span style="color: #000088;">$criteria</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #b1b100;">return</span> parent<span style="color: #339933;">::</span><span style="color: #004000;">findBy</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fixCriteria</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$criteria</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> findOneBy<span style="color: #009900;">&#40;</span><span style="color: #990000;">array</span> <span style="color: #000088;">$criteria</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #b1b100;">return</span> parent<span style="color: #339933;">::</span><span style="color: #004000;">findOneBy</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fixCriteria</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$criteria</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> find<span style="color: #009900;">&#40;</span><span style="color: #000088;">$id</span><span style="color: #339933;">,</span> <span style="color: #000088;">$lockMode</span> <span style="color: #339933;">=</span> \Doctrine\DBAL\LockMode<span style="color: #339933;">::</span><span style="color: #004000;">NONE</span><span style="color: #339933;">,</span> <span style="color: #000088;">$lockVersion</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">findOneBy</span><span style="color: #009900;">&#40;</span><span style="color: #990000;">array</span><span style="color: #009900;">&#40;</span>
        <span style="color: #0000ff;">'id'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #000088;">$id</span>
    <span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">function</span> fixCriteria<span style="color: #009900;">&#40;</span><span style="color: #990000;">array</span> <span style="color: #000088;">$criteria</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #666666; font-style: italic;">//Unless explicitly requested to return deleted items, we want to return non-deleted items by default</span>
    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #990000;">in_array</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'deleted'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$criteria</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$criteria</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'deleted'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">false</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$criteria</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>To achieve our requirement of returning non-deleted entities, we simply make sure that all queries include a criteria that makes the deleted flag false. As such, we always run the search criteria through the fixCriteria function, which makes sure that unless explicitly requested, we will return non-deleted items.</p>
<h3>In closing</h3>
<p>As you can see by utilizing a repository we can easily add custom behaviors into performing queries. However, do note a few gotchas with this approach:</p>
<ul>
<li>When &#8220;deleting&#8221; entities, you should always use the methods in the entity itself and then have the EntityManager persist them</li>
<li>If you perform DQL queries, you will need to include a WHERE-clause to get non-deleted entities</li>
</ul>
<p>The biggest benefit of this approach is received when you make sure your code always uses the repository when querying. This way you can make sure the returned results are always consistent to what is expected.</p>
<p>If you have any suggestions on how to improve this, or any other ideas, feel free to post them in the comments.</p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:100:"http://codeutopia.net/blog/2010/12/04/how-to-create-doctrine-1-style-soft-delete-in-doctrine-2/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:1:"3";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:5;a:6:{s:4:"data";s:47:"
		
		
		
		
		
				
		
		

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:22:"11 common Dojo gotchas";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:61:"http://codeutopia.net/blog/2010/11/27/11-common-dojo-gotchas/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:70:"http://codeutopia.net/blog/2010/11/27/11-common-dojo-gotchas/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Sat, 27 Nov 2010 19:29:43 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:3:{i:0;a:5:{s:4:"data";s:11:"Programming";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:4:"Dojo";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:2;a:5:{s:4:"data";s:10:"JavaScript";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=446";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:306:"Dojo is a great JavaScript toolkit, but it&#8217;s not perfect: It has a couple of gotchas that can be hard to debug just based on the error (or the lack of it). To rectify this, here&#8217;s a list of some common mistakes and their solutions. It&#8217;s usually good to just go through each of these [...]";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:7731:"<p>Dojo is a great JavaScript toolkit, but it&#8217;s not perfect: It has a couple of gotchas that can be hard to debug just based on the error (or the lack of it).</p>
<p>To rectify this, here&#8217;s a list of some common mistakes and their solutions. It&#8217;s usually good to just go through each of these if you can&#8217;t figure out what&#8217;s up &#8211; it has helped me quite many times.</p>
<p><span id="more-446"></span></p>
<h3>Missing dojo.require</h3>
<p>Always remember to require any code you use. Even dijits used through markup require this.</p>
<p>A typical error message for this case is &#8220;my.Thinger is not a constructor&#8221;.</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">dojo.<span style="color: #660066;">require</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'dijit.form.TextBox'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<h3>Missing dojo.parser</h3>
<p>If you use dijits in markup, you need to require dojo&#8217;s parser class in order for them to work.</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">dojo.<span style="color: #660066;">require</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'dojo.parser'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<p>Note that parser has to be required even if you have parseOnLoad enabled.</p>
<h3>No parseOnLoad/dojo.parser.parse</h3>
<p>If your dijits in markup don&#8217;t work, remember to make sure you have either parseOnLoad in djConfig, or that you call dojo.parser.parse</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #003366; font-weight: bold;">var</span> djConfig <span style="color: #339933;">=</span> <span style="color: #009900;">&#123;</span>
    parseOnLoad<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span>
<span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span></pre></div></div>

<h3>Missing dojo.provide</h3>
<p>Always add a dojo.provide when declaring classes. Without it, dojo.require will not function properly.</p>
<p>A typical error you&#8217;ll get for this usually says something like &#8220;Could not load my.Thinger&#8221;.</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">dojo.<span style="color: #660066;">provide</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'my.Thinger'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<h3>No call to startup() with programmatic dijits</h3>
<p>When instanciating dijits programmatically, always remember to call <code>d.startup()</code></p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #003366; font-weight: bold;">var</span> thingy <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> my.<span style="color: #660066;">Thinger</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
thingy.<span style="color: #660066;">startup</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<h3>Trying to access dijit&#8217;s DOM too early</h3>
<p>You should not use a dijit&#8217;s constructor to access the dijit&#8217;s DOM. The function where this should be is either postCreate or startup.</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">constructor<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #006600; font-style: italic;">//this.domNode etc. is not ready yet</span>
<span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
&nbsp;
postCreate<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #006600; font-style: italic;">//this.domNode is ready</span>
<span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
&nbsp;
startup<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #006600; font-style: italic;">//this.domNode is ready</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>Note: If you have child dijits and need to access them, you must use startup instead of postCreate.</p>
<h3>More than one root in a _Templated dijit</h3>
<p>Dijit templates must only have a single root node. If you have more than one, it will not work &#8211; this includes HTML comments!</p>
<p>Wrong:</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">templateString<span style="color: #339933;">:</span> <span style="color: #3366CC;">'&lt;p&gt;foo&lt;/p&gt;&lt;p&gt;bar&lt;/p&gt;'</span></pre></div></div>

<p>Wrong:</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">templateString<span style="color: #339933;">:</span> <span style="color: #3366CC;">'&lt;!-- Main foo --&gt;&lt;p&gt;foo&lt;/p&gt;'</span></pre></div></div>

<p>Right:</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">templateString<span style="color: #339933;">:</span> <span style="color: #3366CC;">'&lt;div&gt;&lt;p&gt;foo&lt;/p&gt;&lt;p&gt;bar&lt;/p&gt;&lt;/div&gt;'</span></pre></div></div>

<h3>Sharing two ID&#8217;s</h3>
<p>Similar to DOM, an ID given to a dijit must be unique.</p>
<h3>Missing theme class</h3>
<p>Dijits not rendering like they should? Make sure you have loaded the correct CSS files and set the body&#8217;s class to the theme&#8217;s name.</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #339933;">&lt;</span>body <span style="color: #003366; font-weight: bold;">class</span><span style="color: #339933;">=</span><span style="color: #3366CC;">&quot;claro&quot;</span><span style="color: #339933;">&gt;</span></pre></div></div>

<h3>Spelling mistakes</h3>
<p>However obvious, this is something that can happen and the error messages produced are rarely useful. </p>
<p>Check all class names, method names, etc. in dojo.provides, requires, dojo.connects and so on.</p>
<h3>Using the wrong docs</h3>
<p>Often Dojo-related google results point to the old, often outdated or poor, documentation of Dojo. You should usually try to find documentation from <a href="http://docs.dojocampus.org/">docs.dojocampus.org</a></p>
<h3>More?</h3>
<p>Do you have a common issue you stumble with when working with Dojo? Share it in the comments!</p>
<p>Thanks to <a href="http://twitter.com/rvdavid">@rvdavid</a> for <a href="http://www.rvdavid.net/two-dojo-javascript-gotchas-that-got-me/">inspiring this post</a> and the guys at the #dojo IRC channel for some suggestions to this list.</p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:66:"http://codeutopia.net/blog/2010/11/27/11-common-dojo-gotchas/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:1:"3";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:6;a:6:{s:4:"data";s:41:"
		
		
		
		
		
				

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:22:"Oulu Open Hack wrap-up";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:61:"http://codeutopia.net/blog/2010/11/12/oulu-open-hack-wrap-up/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:70:"http://codeutopia.net/blog/2010/11/12/oulu-open-hack-wrap-up/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Fri, 12 Nov 2010 11:58:55 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:1:{i:0;a:5:{s:4:"data";s:7:"general";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=423";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:319:"For the past 24 hours, there has been an open hackday/hackfest/hackathon/something in Oulu, Finland &#8211; where I live. This was the first (or second, depending on how you count) open hack day held here, and probably one of the first few held in Finland too. The event The event itself was a hack day, basically [...]";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:3562:"<p>For the past 24 hours, there has been an open hackday/hackfest/hackathon/something in Oulu, Finland &#8211; where I live.</p>
<p>This was the first (or second, depending on how you count) open hack day held here, and probably one of the first few held in Finland too.</p>
<p><span id="more-423"></span></p>
<h3>The event</h3>
<p>The event itself was a <a href="http://en.wikipedia.org/wiki/Hack_Day">hack day</a>, basically a bit like a LAN party but for programming, with the goal of making a demo of something in 24 hours.</p>
<p>There were around 50 people participating at the event, with people from all over Finland.</p>
<p>7 hacks were presented at the end of the event.</p>
<p>Being the first public one I think it worked quite well. There were drinks to be had and pizza to be eaten, one person was locked outside the building for 30 minutes (I think) and had to resort to throwing small stones at the windows to get noticed and back in&#8230; but altogether it was a pretty good start from my perspective.</p>
<h3>My team&#8217;s hack</h3>
<p>I participated in the event with my coworkers <a href="http://twitter.com/kluoma">Kristian</a> and <a href="http://twitter.com/blpete">Petri</a>. </p>
<p>We decided that we&#8217;d hack on a new web service concept we had been planning.</p>
<p>The chosen development tools for this were:</p>
<ul>
<li>PHP 5.3</li>
<li>Zend Framework</li>
<li>Doctrine 2</li>
<li>And some miscelaneous JavaScript things</li>
</ul>
<p>We managed to cobble together a lot of functionality. Kristian worked mostly on making the UI look nice, Petri took care of the infrastructure (servers and such) with me doing most of the PHP/JS coding.</p>
<p>During the work we came into a few conclusions:</p>
<ul>
<li>Doctrine 2 rocks and is perfectly usable for production</li>
<li>HTML5 geolocation is pretty useful and it works even on a laptop with no GPS</li>
</ul>
<h3>Other cool hacks</h3>
<p>After the demos everyone voted for their favorite Qt, UBI and other hacks. (A UBI display is a technology being developed at the University of Oulu, which is basically a big touch screen with some stuff in it. See <a href="http://www.ubioulu.fi/en">the UBI website</a> for more details.)</p>
<p>Here are my favorites of the bunch:</p>
<p>QuiaQuia, a Qt-based client for HeiaHeia. The team that made it had even managed to throw in some polish in form of nice UI transitions between views and it ran on Nokia&#8217;s mobile phones.</p>
<p>4squbi, a FourSquare app for UBI displays. It displays your location and nearby FourSquare locations and tips, with a map. (<a href="http://codeutopia.net/blog-images/4squbi.jpg">Photo</a>)</p>
<p>MisterWorm, a text-based version, kind of like a text adventure game, of the good old &#8220;worm game&#8221;. It even <a href="http://twitter.com/mister_worm">integrated with twitter</a>, posting where the worm was going there!</p>
<p>The others were very nice too, and you can find a list of them at <a href="http://ouluhack.pbworks.com/w/page/32458659/Hack-Entries">Oulu Open Hack&#8217;s wiki</a></p>
<h3>In closing</h3>
<p>All in all this was a fun event. I wish I could have stayed the night and hacked at our app, but I had felt a bit under the weather so I decided to play it safe and get some sleep. Still, we got a lot done.</p>
<p>Thanks to the organizers and sponsors for making this event possible. Hopefully we can do this again next year!</p>
<p>Search on twitter for <a href="http://twitter.com/search?q=%23ouluopenhack">#ouluopenhack</a> for some tweets and photos from the event.</p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:66:"http://codeutopia.net/blog/2010/11/12/oulu-open-hack-wrap-up/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:1:"1";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:7;a:6:{s:4:"data";s:44:"
		
		
		
		
		
				
		

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:45:"Bored of Apache/LightHTTPD/etc.? Try Mongrel2";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:80:"http://codeutopia.net/blog/2010/10/28/bored-of-apachelighthttpdetc-try-mongrel2/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:89:"http://codeutopia.net/blog/2010/10/28/bored-of-apachelighthttpdetc-try-mongrel2/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Thu, 28 Oct 2010 16:09:33 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:7:"general";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:3:"Web";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=418";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:337:"Mongrel is a refreshing approach to web servers. We&#8217;re all familiar with the Apache server and many of us have used Lighthttpd and Nginx and maybe some others too. So what makes Mongrel special? It&#8217;s language agnostic. It doesn&#8217;t have a PHP module, it doesn&#8217;t have a Python module, and yet you can still use [...]";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:2777:"<p>Mongrel is a refreshing approach to web servers. We&#8217;re all familiar with the Apache server and many of us have used Lighthttpd and Nginx and maybe some others too.</p>
<p>So what makes Mongrel special? It&#8217;s language agnostic. It doesn&#8217;t have a PHP module, it doesn&#8217;t have a Python module, and yet you can still use those languages (and plenty more) with it, with very little effort to integrate new languages.</p>
<p><span id="more-418"></span></p>
<h3>Simplified overview of mongrel&#8217;s architecture</h3>
<p>When serving a PHP application, a server like Apache processes the HTTP request and then invokes some module &#8211; mod_php in PHP&#8217;s case &#8211; which then processes the scripting language in question and so on.</p>
<p>Mongrel? It just processes the HTTP request.</p>
<p>How does it do anything useful then, you ask? Well, it uses a message queue &#8211; specifically <a href="http://www.zeromq.org/">ZeroMQ</a> &#8211; to send the request to any takers.</p>
<p>So the HTTP request comes to Mongrel, which then processes it and converts it into a sensible format containing the vital info (headers, parameters, etc., in JSON) and gives it to ZeroMQ. It then just waits for a reply from ZeroMQ.</p>
<p>Since ZeroMQ is just a message queue, you need to have something listening for messages and replying to them. Perhaps it&#8217;s a PHP application, Python or whatever &#8211; ZeroMQ and Mongrel don&#8217;t care. </p>
<h3>This makes Mongrel special</h3>
<p>Herein lies the thing that makes Mongrel special: It&#8217;s easy to replace apps and scale. The server doesn&#8217;t care at all what processes the request.</p>
<p>You can have a PHP app. You can then rewrite it in Python, and nobody will notice you changed it. All you had to do was to stop the PHP app and start the Python app &#8211; heck, you could even have both running at the same time, serving messages from ZeroMQ on a first-come first-serve basis.</p>
<p>This makes it very simple to scale it too &#8211; Just throw in some more applications listening for messages in the queue.</p>
<p>Mongrel2 is also designed so that it&#8217;s quite easy to configure, and it has very good documentation making it easy to get started.</p>
<p><br/><br />
<br/><br />
I recommend that you <a href="http://mongrel2.org/">check out Mongrel2</a>, if for nothing else, for the simple reason that it&#8217;s doing things differently from the mass.</p>
<p>I will probably be doing a post later about my adventures in Mongrel2 and Haskell web application development &#8211; once I get it diong anything interesting which may take a bit since I&#8217;m a Haskell-noob <img src='http://codeutopia.net/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:85:"http://codeutopia.net/blog/2010/10/28/bored-of-apachelighthttpdetc-try-mongrel2/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:2:"10";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:8;a:6:{s:4:"data";s:44:"
		
		
		
		
		
				
		

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:49:"Danmaku mechanics in first/third person shooters?";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:86:"http://codeutopia.net/blog/2010/10/22/danmaku-mechanics-in-firstthird-person-shooters/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:95:"http://codeutopia.net/blog/2010/10/22/danmaku-mechanics-in-firstthird-person-shooters/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Fri, 22 Oct 2010 20:54:39 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:2:{i:0;a:5:{s:4:"data";s:7:"general";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:5:"Games";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=405";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:320:"While there are some good shooters coming out lately, no one is really pushing to improve the genre with new ideas or concepts. Most games build on the shoulders of the previous ones, merely improving areas here and there. What if you were to combine two genres of shooters which are distinctly different from each [...]";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:4367:"<p>While there are some good shooters coming out lately, no one is really pushing to improve the genre with new ideas or concepts. Most games build on the shoulders of the previous ones, merely improving areas here and there.</p>
<p>What if you were to combine two genres of shooters which are distinctly different from each other? </p>
<p>What if you would combine some ideas from danmaku, or &#8220;bullet hell&#8221;, shooters into first person (or third person) shooters?</p>
<p><span id="more-405"></span></p>
<h3>Danmaku for the unfamiliar</h3>
<div class="image right"><a href="http://codeutopia.net/blog-images/1191850978829.jpg"><img width="200" src="http://codeutopia.net/blog-images/1191850978829.jpg" alt="Touhou: Perfect Cherry Blossom screenshot" /><br />Lots of stuff all trying to get you!</a></div>
<p>If you&#8217;re not familiar with the term, bullet hell shooters are basically top-down shooters &#8211; Similar to games like Tyrian or Raptor: Call of the Shadows, or even the venerable Space Invaders.</p>
<p>The main difference between &#8220;normal&#8221; top-down shooters and bullet hell shooters is that in bullet hell shooters there tends to be a crazy amount of stuff flying at you &#8211; Maybe not so surprising after hearing the genre&#8217;s name.</p>
<p>Some examples of the games in this genre are <a href="http://www.youtube.com/watch?v=FtFkpldJSpY">DonPachi series</a>, some games in the <a href="http://www.youtube.com/watch?v=V58H5j8jBAc&#038;feature=related">Touhou series</a>, Ikaruga, etc.</p>
<h3>The game mechanics</h3>
<div class="image right"><img width="200" src="http://codeutopia.net/blog-images/camp.jpg" alt="Camping is fun" /><br />Static gameplay, aka camping</div>
<p>Typical first person shooters of today are in a semi-realistic style where you tend to get killed pretty easily. This leads to a slightly static gameplay and encourages the use of cover.</p>
<p>While this isn&#8217;t necessarily bad &#8211; and not even the case in all games (like Quake) &#8211; I think it would be refreshing to see some new ideas put into the genre.</p>
<p>I think it might be interesting to see a concept from bullet hell games in first person shooters to spice things up a little.</p>
<p>The mechanic I suggest copying is <em>the bullet grazing modifier</em>. I have no idea what the correct term for it, but the basic concept goes like this:</p>
<p><strong>When you are very close to an enemy bullet, you get a bonus</strong>.</p>
<p>Typically this bonus is something like increasing your score modifier, giving your weapon more fire power or maybe filling a power-up bar. </p>
<p>This means that if you take the risk of possibly hitting an enemy bullet (and losing a life, as many danmaku have no concept of health), you are rewarded.</p>
<h3>How bullet-grazing bonus would work in a 1st/3rd person shooter?</h3>
<p>If we take the concept of getting a bonus when being close to getting hit, we could encourage a more active, faster gameplay.</p>
<p>If you are being fired upon by an enemy, you would have two choices: Either play in a more tactical way and use cover, or play like an action movie hero and duke it out in the clear.</p>
<ul>
<li><strong>If you seek cover</strong>, you are less likely to lose health (or die), but you will gain no other bonuses.</li>
<li><strong>If you stay in the fire</strong>, you are more likely to take damage, but you could get a bonus such as improved speed, improved damage or improved accuracy.</li>
</ul>
<p>I think a system where you would gain a bonus for not hiding would be interesting to see, as it could allow players who enjoy a more fast-paced gameplay keep playing like that, while still allowing the use of cover if wanted.</p>
<h3>In closing</h3>
<div class="image right"><img width="200" src="http://codeutopia.net/blog-images/commando.jpg" alt="Commando" /><br />The best movie ever.</div>
<p>I think we could even go as far as say this would make shooters more like action movies &#8211; and as a fan of both first person shooters and classic action movies, this is something I&#8217;ve occasionally been wondering about.</p>
<p>So by providing a reward for risky run-and-gun gameplay, could the first person shooter genre be made more interesting? I believe so. </p>
<p>So what say you?</p>
<p>The images in this post were liberated from google images search.</p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:91:"http://codeutopia.net/blog/2010/10/22/danmaku-mechanics-in-firstthird-person-shooters/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:1:"4";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}i:9;a:6:{s:4:"data";s:50:"
		
		
		
		
		
				
		
		
		

		
		
			
			
		
		";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";s:5:"child";a:5:{s:0:"";a:7:{s:5:"title";a:1:{i:0;a:5:{s:4:"data";s:45:"Optimizing SQL: Removing queries inside loops";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:83:"http://codeutopia.net/blog/2010/10/07/optimizing-sql-removing-queries-inside-loops/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:92:"http://codeutopia.net/blog/2010/10/07/optimizing-sql-removing-queries-inside-loops/#comments";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:7:"pubDate";a:1:{i:0;a:5:{s:4:"data";s:31:"Thu, 07 Oct 2010 17:36:03 +0000";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:8:"category";a:4:{i:0;a:5:{s:4:"data";s:11:"Programming";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:1;a:5:{s:4:"data";s:9:"Databases";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:2;a:5:{s:4:"data";s:11:"Performance";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}i:3;a:5:{s:4:"data";s:3:"SQL";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:4:"guid";a:1:{i:0;a:5:{s:4:"data";s:33:"http://codeutopia.net/blog/?p=398";s:7:"attribs";a:1:{s:0:"";a:1:{s:11:"isPermaLink";s:5:"false";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:11:"description";a:1:{i:0;a:5:{s:4:"data";s:321:"I mentioned shortly on twitter that you should avoid using SQL queries inside loops. There was some questions on how, so here&#8217;s a short post that hopefully explains some tricks that you can use. Why? Before how, let&#8217;s quickly look at why. When you have an SQL query inside a loop it means it&#8217;s ran [...]";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:32:"http://purl.org/dc/elements/1.1/";a:1:{s:7:"creator";a:1:{i:0;a:5:{s:4:"data";s:16:"Jani Hartikainen";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:40:"http://purl.org/rss/1.0/modules/content/";a:1:{s:7:"encoded";a:1:{i:0;a:5:{s:4:"data";s:7123:"<p>I mentioned shortly on twitter that you should avoid using SQL queries inside loops. There was some questions on how, so here&#8217;s a short post that hopefully explains some tricks that you can use.</p>
<p><span id="more-398"></span></p>
<h3>Why?</h3>
<p>Before how, let&#8217;s quickly look at why.</p>
<p>When you have an SQL query inside a loop it means it&#8217;s ran more than once, which is pretty obvious. So by moving the query outside the loop, so it&#8217;s executed only once, usually nets a performance boost.</p>
<p>Another reason why queries inside loops are bad is that often the number of iterations depends on how many objects another query returns. Sure, with a small amount of data your loop is probably pretty fast, but when you end up with more data, it will start becoming slower and slower.</p>
<h3>How?</h3>
<p>Now, let&#8217;s check out some simple solutions.</p>
<h4>Using JOINs</h4>
<p>If you are not familiar with SQL&#8217;s joins, I suggest familiarizing yourself with them right away, as they are immensely useful. With joins, you can, for example, select from multiple tables in a single query, so you could for example join related data from another table that you need. This is similar to the approach demonstrated in the next example&#8230;</p>
<h4>Using GROUP BY</h4>
<p>You often use aggregate functions in queries in loops &#8211; in other words, you may be COUNTing something, or selecting a MAX something and so on.</p>
<p>A typical counting scenario:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;">SELECT <span style="color: #339933;">*</span> FROM products
&nbsp;
<span style="color: #339933;">-</span> <span style="color: #b1b100;">for</span> <span style="color: #990000;">each</span> product
    <span style="color: #b1b100;">print</span> product details
    SELECT <span style="color: #990000;">COUNT</span><span style="color: #009900;">&#40;</span>id<span style="color: #009900;">&#41;</span> FROM sold_products WHERE product_id <span style="color: #339933;">=</span> product<span style="color: #0000ff;">'s ID
    print how many of this product has been sold</span></pre></div></div>

<p>We can run this in one go by using a JOIN and a GROUP BY:</p>

<div class="wp_syntax"><div class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">SELECT</span> products<span style="color: #66cc66;">.*,</span> COUNT<span style="color: #66cc66;">&#40;</span>sold_products<span style="color: #66cc66;">.</span>id<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">AS</span> total_sold
<span style="color: #993333; font-weight: bold;">FROM</span> products
<span style="color: #993333; font-weight: bold;">LEFT</span> <span style="color: #993333; font-weight: bold;">JOIN</span> sold_products <span style="color: #993333; font-weight: bold;">ON</span> sold_products<span style="color: #66cc66;">.</span>product_id <span style="color: #66cc66;">=</span> product<span style="color: #66cc66;">.</span>id
<span style="color: #993333; font-weight: bold;">GROUP</span> <span style="color: #993333; font-weight: bold;">BY</span> sold_products<span style="color: #66cc66;">.</span>product_id</pre></div></div>

<p>By using a query like this, each of the product rows gets an additional column called &#8220;total_sold&#8221; which has the count from the other table we joined. By grouping the query by the product ID, the database knows how it should perform the counting.</p>
<p>This same approach can be used for other types of queries using aggregate functions as well.</p>
<h4>Using subselects</h4>
<p>A subselect is essentially a SELECT inside a SELECT. They can be used in the column listing, joins and where clause (depends on your DB really but these are common).</p>

<div class="wp_syntax"><div class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">SELECT</span> a_column<span style="color: #66cc66;">,</span>
           <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">SELECT</span> b <span style="color: #993333; font-weight: bold;">FROM</span> c<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">AS</span> other_value
<span style="color: #66cc66;">...</span></pre></div></div>

<p>In a where, subselect values can be used for comparison, for example&#8230;</p>

<div class="wp_syntax"><div class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">...</span>
<span style="color: #993333; font-weight: bold;">FROM</span> <span style="color: #66cc66;">...</span>
<span style="color: #993333; font-weight: bold;">WHERE</span> some_column <span style="color: #66cc66;">=</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">...</span><span style="color: #66cc66;">&#41;</span></pre></div></div>

<p>It should be noted that joins can often achieve the same result with better speed.</p>
<h4>Using batch inserts</h4>
<p>Not all looped queries are selects. Inserting multiple rows is also a common thing to do.</p>
<p>To speed up inserting a lot of data, you can batch your rows into a single insert. The syntax to do that is as follow:</p>

<div class="wp_syntax"><div class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> some_table <span style="color: #66cc66;">&#40;</span>col1<span style="color: #66cc66;">,</span> col2<span style="color: #66cc66;">&#41;</span> 
<span style="color: #993333; font-weight: bold;">VALUES</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'row1-col1'</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">'row1-col2'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> 
       <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'row2-col1'</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">'row2-col2'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> 
       <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">...</span> <span style="color: #993333; font-weight: bold;">AND</span> so <span style="color: #993333; font-weight: bold;">ON</span> <span style="color: #66cc66;">...</span><span style="color: #66cc66;">&#41;</span></pre></div></div>

<h3>In closing</h3>
<p>I hope the examples shown here explained this optimizing technique a bit better. These are still just scratching the surface on what you can do with joins, grouping and such, so I would suggest you consult your database of choice&#8217;s manual for a deeper explanation.</p>
<p>I&#8217;m sure these are not all the ways you could avoid querying in loops. If you know any more, feel free to share</p>
";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:36:"http://wellformedweb.org/CommentAPI/";a:1:{s:10:"commentRss";a:1:{i:0;a:5:{s:4:"data";s:88:"http://codeutopia.net/blog/2010/10/07/optimizing-sql-removing-queries-inside-loops/feed/";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:38:"http://purl.org/rss/1.0/modules/slash/";a:1:{s:8:"comments";a:1:{i:0;a:5:{s:4:"data";s:1:"8";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}s:27:"http://www.w3.org/2005/Atom";a:1:{s:4:"link";a:1:{i:0;a:5:{s:4:"data";s:0:"";s:7:"attribs";a:1:{s:0:"";a:3:{s:4:"href";s:32:"http://codeutopia.net/blog/feed/";s:3:"rel";s:4:"self";s:4:"type";s:19:"application/rss+xml";}}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}s:44:"http://purl.org/rss/1.0/modules/syndication/";a:2:{s:12:"updatePeriod";a:1:{i:0;a:5:{s:4:"data";s:6:"hourly";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}s:15:"updateFrequency";a:1:{i:0;a:5:{s:4:"data";s:1:"1";s:7:"attribs";a:0:{}s:8:"xml_base";s:0:"";s:17:"xml_base_explicit";b:0;s:8:"xml_lang";s:0:"";}}}}}}}}}}}}s:4:"type";i:128;s:7:"headers";a:10:{s:4:"date";s:29:"Tue, 22 Feb 2011 14:21:05 GMT";s:6:"server";s:21:"Apache/2.2.3 (CentOS)";s:12:"x-powered-by";s:9:"PHP/5.2.6";s:4:"vary";s:6:"Cookie";s:10:"x-pingback";s:37:"http://codeutopia.net/blog/xmlrpc.php";s:4:"etag";s:32:"b53f3e49a5d673fc3806909abdb910bd";s:14:"wp-super-cache";s:8:"WP-Cache";s:10:"connection";s:5:"close";s:17:"transfer-encoding";s:7:"chunked";s:12:"content-type";s:23:"text/xml; charset=UTF-8";}s:5:"build";s:14:"20110128231735";}